<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaksMate - Pembagian Tugas Tim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
        }

        .app-name {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: #2e7d32;
        }

        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #c8e6c9;
            border-top: 4px solid #2e7d32;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(46, 125, 50, 0.1);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            animation: fadeInUp 0.5s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-card h2 {
            color: #2e7d32;
            margin-bottom: 30px;
        }

        .btn-primary {
            background: #2e7d32;
            border: none;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px 0;
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 2px solid #e8f5e9;
            margin-bottom: 20px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-menu li {
            margin: 5px 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .sidebar-menu i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f5e9;
        }

        .page-header h3 {
            color: #2e7d32;
            font-weight: 600;
        }

        .table {
            font-family: 'Times New Roman', serif;
        }

        .table thead {
            background: #2e7d32;
            color: white;
        }

        .btn-success {
            background: #2e7d32;
            border: none;
        }

        .btn-success:hover {
            background: #1b5e20;
        }

        .btn-danger {
            background: #c62828;
            border: none;
        }

        .chat-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.public {
            background: #e8f5e9;
            border-left: 4px solid #2e7d32;
        }

        .message.private {
            background: #fff3e0;
            border-left: 4px solid #f57c00;
        }

        .message-header {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 0.8em;
            color: #666;
        }

        .skill-badge {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 15px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block !important;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: #2e7d32;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
            }
            
            .sidebar-logout {
                display: none;
            }
        }

        .mobile-menu-btn {
            display: none;
        }

        .assignment-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 5px solid #2e7d32;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .assignment-card h5 {
            color: #2e7d32;
            font-weight: 600;
        }

        .archive-item {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .archive-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .archive-item.overdue {
            border-left-color: #dc3545;
        }

        .archive-item.completed {
            border-left-color: #28a745;
        }

        .archive-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .empty-archive {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .archive-stats {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .priority-low {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .priority-medium {
            background-color: #fff3cd;
            color: #856404;
        }

        .priority-high {
            background-color: #f8d7da;
            color: #721c24;
        }

        .activity-timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 20px;
        }
        
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }
        
        .activity-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #2e7d32;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: slideInRight 0.3s;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .activity-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2e7d32;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #2e7d32;
        }
        
        .activity-item.system {
            border-left-color: #2196f3;
        }
        
        .activity-item.system::before {
            background: #2196f3;
            box-shadow: 0 0 0 2px #2196f3;
        }
        
        .activity-item.warning {
            border-left-color: #ff9800;
        }
        
        .activity-item.warning::before {
            background: #ff9800;
            box-shadow: 0 0 0 2px #ff9800;
        }
        
        .activity-item.danger {
            border-left-color: #f44336;
        }
        
        .activity-item.danger::before {
            background: #f44336;
            box-shadow: 0 0 0 2px #f44336;
        }
        
        .activity-item.success {
            border-left-color: #4caf50;
        }
        
        .activity-item.success::before {
            background: #4caf50;
            box-shadow: 0 0 0 2px #4caf50;
        }
        
        .activity-icon {
            font-size: 1.2em;
            margin-right: 10px;
            width: 30px;
            text-align: center;
        }
        
        .activity-time {
            font-size: 0.85em;
            color: #666;
            margin-left: 10px;
        }
        
        .activity-user {
            font-weight: 600;
            color: #2e7d32;
        }
        
        .activity-content {
            margin-top: 5px;
            color: #333;
        }
        
        .activity-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            padding-left: 20px;
        }
        
        .activity-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .activity-filter {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .activity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-card i {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-card h4 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .stat-card p {
            margin: 5px 0 0;
            color: #666;
            font-size: 0.9em;
        }

        /* =============== ADMIN STYLES =============== */
        .admin-badge {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .delete-modal .modal-content {
            border: 3px solid #dc3545;
        }

        .delete-modal .modal-header {
            background: #dc3545;
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .user-status.online {
            background-color: #28a745;
        }

        .user-status.offline {
            background-color: #6c757d;
        }

        .user-status.away {
            background-color: #ffc107;
        }

        .admin-table th {
            background: #2e7d32;
            color: white;
            position: sticky;
            top: 0;
        }

        .admin-table td {
            vertical-align: middle;
        }

        .permission-badge {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 3px;
        }

        .permission-admin {
            background-color: #dc3545;
            color: white;
        }

        .permission-editor {
            background-color: #007bff;
            color: white;
        }

        .permission-viewer {
            background-color: #6c757d;
            color: white;
        }

        .last-activity {
            font-size: 0.85em;
            color: #6c757d;
        }

        #adminMenuButton {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white !important;
            margin: 5px 20px;
            border-radius: 10px;
        }

        #adminMenuButton:hover {
            background: linear-gradient(135deg, #c82333 0%, #b21f2d 100%);
            transform: translateY(-2px);
        }

        .stat-card-small {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .stat-card-small i {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .stat-card-small h4 {
            margin: 0;
            font-size: 1.3em;
        }

        .stat-card-small p {
            margin: 5px 0 0;
            color: #666;
            font-size: 0.85em;
        }

        /* =============== TASK ASSIGNMENT STYLES =============== */
        .assign-members-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            background: #f8f9fa;
        }

        .assign-member-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #2e7d32;
            transition: all 0.2s;
        }

        .assign-member-item:hover {
            background: #e8f5e9;
            transform: translateX(3px);
        }

        .assign-member-item.selected {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .assign-member-checkbox {
            margin-right: 10px;
        }

        .assigned-badge {
            background: #2e7d32;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: auto;
        }

        .task-assignees {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .task-assignee-badge {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
        }

        .task-assignee-badge i {
            margin-right: 3px;
        }

        .assign-btn {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .assign-btn:hover {
            background: #1b5e20;
            transform: translateY(-2px);
        }

        .assign-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal untuk menetapkan anggota */
        .assign-modal .modal-dialog {
            max-width: 600px;
        }

        .assign-modal .modal-header {
            background: #2e7d32;
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .assign-member-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* =============== SUBTASK STYLES =============== */
        .subtask-list {
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .subtask-checkbox:checked + label {
            text-decoration: line-through;
            color: #6c757d;
        }

        .form-check-label {
            cursor: pointer;
            user-select: none;
            font-size: 0.9em;
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        /* Task Detail Modal */
        .task-detail-modal .modal-header {
            background: #2e7d32;
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .subtask-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .subtask-item.completed {
            background: #d4edda;
            opacity: 0.8;
        }

        .subtask-check {
            margin-right: 10px;
            margin-top: 3px;
        }

        .subtask-content {
            flex: 1;
        }

        .subtask-meta {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }

        /* Tabel Members - MODIFIKASI untuk kekurangan */
        #membersTable td {
            vertical-align: middle;
        }

        #membersTable .skill-badge {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 10px;
            font-size: 0.75em;
            white-space: normal;
            word-break: break-word;
        }

        #membersTable .weakness-badge {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 10px;
            font-size: 0.75em;
            white-space: normal;
            word-break: break-word;
        }

        #membersTable .badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }

        /* Filter Tabel */
        .table-filter {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Responsive Table */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.85em;
            }
            
            .btn-group .btn {
                padding: 3px 6px;
            }
            
            .skill-badge, .weakness-badge {
                font-size: 0.7em;
                padding: 2px 6px;
                margin: 1px;
            }
        }
        
        /* =============== SIDEBAR LOGOUT STYLES =============== */
        .sidebar-footer {
            padding: 20px;
            border-top: 2px solid #e8f5e9;
            margin-top: auto;
            background: white;
        }
        
        .sidebar-logout {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            color: #dc3545;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            text-align: left;
        }
        
        .sidebar-logout:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .sidebar-logout i {
            margin-right: 10px;
            font-size: 1.1em;
        }
        
        .user-info-sidebar {
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px;
            border-left: 4px solid #2e7d32;
        }
        
        .user-info-sidebar h6 {
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .user-info-sidebar p {
            font-size: 0.9em;
            color: #666;
            margin: 0;
        }
        
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
            
            .sidebar-logout {
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar-footer {
                display: none;
            }
            
            .user-info-sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Auth Container (Login/Register) -->
    <div id="authContainer" style="display: none;">
        <!-- Login Form -->
        <div id="loginForm" class="auth-container">
            <div class="auth-card">
                <div class="mb-4 text-start" style="margin-left: -10px;">
                    <img src="logo.png" alt="" style="width: 200px; height: 100px;">
                </div>
                <form onsubmit="handleLogin(event)">
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-envelope me-2"></i>Email</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-lock me-2"></i>Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rememberMe">
                        <label class="form-check-label" for="rememberMe">
                            Ingat Saya
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-sign-in-alt me-2"></i>Masuk
                    </button>
                    <div class="text-center">
                        <a href="#" onclick="showForgotPassword()" class="text-decoration-none">Lupa Password?</a>
                        <div class="mt-3">
                            Belum punya akun? <a href="#" onclick="showRegister()" class="text-decoration-none fw-bold">Daftar</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="auth-container" style="display: none;">
            <div class="auth-card">
                <div class="text-center mb-4">
                    <i class="fas fa-user-plus fa-3x text-success mb-3"></i>
                    <h2 class="app-name">Daftar Akun</h2>
                </div>
                <form onsubmit="handleRegister(event)">
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-user me-2"></i>Nama Lengkap</label>
                        <input type="text" class="form-control" id="regName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-envelope me-2"></i>Email</label>
                        <input type="email" class="form-control" id="regEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-lock me-2"></i>Password</label>
                        <input type="password" class="form-control" id="regPassword" minlength="6" required>
                        <small class="text-muted">Minimal 6 karakter</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-lock me-2"></i>Konfirmasi Password</label>
                        <input type="password" class="form-control" id="regConfirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-user-plus me-2"></i>Daftar
                    </button>
                    <div class="text-center">
                        Sudah punya akun? <a href="#" onclick="showLogin()" class="text-decoration-none fw-bold">Masuk</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgotPasswordForm" class="auth-container" style="display: none;">
            <div class="auth-card">
                <div class="text-center mb-4">
                    <i class="fas fa-key fa-3x text-success mb-3"></i>
                    <h2 class="app-name">Lupa Password</h2>
                    <p class="text-muted">Masukkan email untuk reset password</p>
                </div>
                <form onsubmit="handleForgotPassword(event)">
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-envelope me-2"></i>Email</label>
                        <input type="email" class="form-control" id="forgotEmail" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-paper-plane me-2"></i>Kirim Link Reset
                    </button>
                    <div class="text-center">
                        <a href="#" onclick="showLogin()" class="text-decoration-none">Kembali ke Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h4 class="app-name mb-1">TaksMate</h4>
                <small class="text-muted" id="userWelcome">Selamat datang!</small>
            </div>
            
            <!-- User Info Section -->
            <div class="user-info-sidebar" id="userInfoSidebar">
                <h6 id="sidebarUserName">Nama Pengguna</h6>
                <p id="sidebarUserEmail">email@contoh.com</p>
                <p id="sidebarUserRole"><small>Role: Member</small></p>
            </div>
            
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#" onclick="showPage('tasks')"><i class="fas fa-tasks"></i> Daftar Tugas</a></li>
                <li><a href="#" onclick="showPage('members')"><i class="fas fa-users"></i> Anggota Tim</a></li>
                <li><a href="#" onclick="showPage('assignments')"><i class="fas fa-clipboard-check"></i> Pembagian Tugas</a></li>
                <li><a href="#" onclick="showPage('archive')"><i class="fas fa-archive"></i> Arsip Tugas</a></li>
                <li><a href="#" onclick="showPage('chat')"><i class="fas fa-comments"></i> Chat Tim</a></li>
                <li><a href="#" onclick="showPage('activity')"><i class="fas fa-history"></i> Riwayat Aktivitas</a></li>
                <li><a href="#" onclick="showPage('profile')"><i class="fas fa-user"></i> Profil Saya</a></li>
                <!-- Admin Menu (Hanya tampil untuk admin) -->
                <li><a href="#" onclick="showAdminPanel()" id="adminMenuButton" style="display: none;">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </a></li>
                <!-- Logout item untuk mobile -->
                <li class="mobile-logout-item"><a href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
            
            <!-- Footer dengan Logout Button untuk Desktop -->
            <div class="sidebar-footer">
                <button class="sidebar-logout" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> Keluar dari Akun
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard -->
            <div id="dashboardPage" class="page">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-home me-2"></i>Dashboard</h3>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-tasks fa-3x text-success mb-3"></i>
                                    <h4 id="totalTasks">0</h4>
                                    <p class="text-muted">Tugas Aktif</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                    <h4 id="overdueTasks">0</h4>
                                    <p class="text-muted">Tugas Terlewat</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-archive fa-3x text-info mb-3"></i>
                                    <h4 id="archivedCount">0</h4>
                                    <p class="text-muted">Di Arsip</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-users fa-3x text-success mb-3"></i>
                                    <h4 id="totalMembers">0</h4>
                                    <p class="text-muted">Anggota Tim</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-comments fa-3x text-success mb-3"></i>
                                    <h4 id="totalMessages">0</h4>
                                    <p class="text-muted">Pesan</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-clipboard-check fa-3x text-success mb-3"></i>
                                    <h4 id="totalAssignments">0</h4>
                                    <p class="text-muted">Penugasan</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h4 id="completedTasks">0</h4>
                                    <p class="text-muted">Tugas Selesai</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-history fa-3x text-info mb-3"></i>
                                    <h4 id="todayActivities">0</h4>
                                    <p class="text-muted">Aktivitas Hari Ini</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="tasksPage" class="page" style="display: none;">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-tasks me-2"></i>Daftar Tugas</h3>
                    </div>
                    <form onsubmit="addTask(event)" class="mb-4">
                        <div class="row mb-3">
                            <div class="col-md-5">
                                <input type="text" class="form-control" id="taskInput" placeholder="Nama tugas..." required>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="taskDeadline" required>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="taskPriority">
                                    <option value="low">Prioritas Rendah</option>
                                    <option value="medium" selected>Prioritas Sedang</option>
                                    <option value="high">Prioritas Tinggi</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-plus me-2"></i>Tambah
                                </button>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <select class="form-select" id="taskCategory">
                                    <option value="">Pilih Kategori</option>
                                    <option value="design">Desain</option>
                                    <option value="development">Pengembangan</option>
                                    <option value="marketing">Pemasaran</option>
                                    <option value="research">Riset</option>
                                    <option value="meeting">Rapat</option>
                                    <option value="documentation">Dokumentasi</option>
                                    <option value="testing">Testing</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="taskAssignedTo" multiple>
                                    <option value="" disabled>Pilih Anggota (Bisa lebih dari satu)</option>
                                </select>
                                <small class="text-muted">Tekan Ctrl/Cmd untuk memilih beberapa anggota</small>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label"><i class="fas fa-list-check me-2"></i>Sub-tugas / Daftar Pekerjaan</label>
                                <textarea class="form-control" id="taskSubtasks" 
                                          placeholder="Masukkan daftar pekerjaan yang perlu diselesaikan (pisahkan dengan baris baru)" 
                                          rows="3"></textarea>
                                <small class="text-muted">Tekan Enter untuk membuat baris baru</small>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Tugas</th>
                                    <th>Detail Tugas</th>
                                    <th>Prioritas</th>
                                    <th>Deadline</th>
                                    <th>Ditugaskan Kepada</th>
                                    <th>Status</th>
                                    <th>Dibuat Oleh</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tasksList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Members Page (TABLE VERSION) dengan MODIFIKASI: Tambah kolom kekurangan, hapus kolom role -->
            <div id="membersPage" class="page" style="display: none;">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-users me-2"></i>Anggota Tim</h3>
                        <p class="text-muted mb-0">Kelola anggota tim, kelebihan, kekurangan, dan keterampilan mereka</p>
                    </div>
                    
                    <!-- Form Tambah Anggota dengan MODIFIKASI: Tambah input kekurangan -->
                    <form onsubmit="addMember(event)" class="mb-4">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <input type="text" class="form-control" id="memberName" placeholder="Nama Lengkap" required>
                            </div>
                            <div class="col-md-4 mb-2">
                                <input type="email" class="form-control" id="memberEmail" placeholder="Email">
                            </div>
                            <div class="col-md-4 mb-2">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-user-plus me-2"></i>Tambah Anggota
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4 mb-2">
                                <input type="text" class="form-control" id="memberStrength" placeholder="Kelebihan Utama">
                            </div>
                            <div class="col-md-4 mb-2">
                                <input type="text" class="form-control" id="memberWeakness" placeholder="Kekurangan (pisahkan koma)">
                            </div>
                            <div class="col-md-4 mb-2">
                                <input type="text" class="form-control" id="memberSoftSkills" placeholder="Soft Skills (pisahkan koma)">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4 mb-2">
                                <input type="text" class="form-control" id="memberHardSkills" placeholder="Hard Skills (pisahkan koma)">
                            </div>
                            <div class="col-md-8 mb-2">
                                <textarea class="form-control" id="memberNotes" placeholder="Catatan tambahan..." rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Filter dan Search -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="memberSearch" 
                                   placeholder="Cari nama..." onkeyup="filterMembersTable()">
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-success w-100" onclick="exportMembersData()">
                                <i class="fas fa-download me-2"></i>Export Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-users text-primary"></i>
                                <h4 id="totalMembersCount">0</h4>
                                <p>Total Anggota</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-star text-warning"></i>
                                <h4 id="strengthCount">0</h4>
                                <p>Memiliki Kelebihan</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-tasks text-success"></i>
                                <h4 id="activeTasksCount">0</h4>
                                <p>Tugas Aktif</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-chart-pie text-info"></i>
                                <h4 id="avgSkillsCount">0</h4>
                                <p>Rata-rata Skills</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabel Anggota dengan MODIFIKASI: Tambah kolom kekurangan, hapus kolom role -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="membersTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nama Lengkap</th>
                                    <th>Email</th>
                                    <th>Kelebihan</th>
                                    <th>Kekurangan</th>
                                    <th>Skills</th>
                                    <th>Tugas Aktif</th>
                                    <th>Ditambahkan</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                <!-- Data akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="membersEmptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-users-slash fa-3x mb-3 text-muted"></i>
                        <h5>Belum ada anggota tim</h5>
                        <p class="text-muted">Tambahkan anggota tim terlebih dahulu</p>
                    </div>
                </div>
            </div>

            <!-- Assignments Page -->
            <div id="assignmentsPage" class="page" style="display: none;">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-clipboard-check me-2"></i>Pembagian Tugas</h3>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select" id="autoAssignType">
                                <option value="manual">Pilih metode pembagian...</option>
                                <option value="equal">Bagi ke Semua Anggota</option>
                                <option value="skills">Berdasarkan Skills</option>
                                <option value="random">Random Assignment</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-success w-100" onclick="generateAssignments()">
                                <i class="fas fa-magic me-2"></i>Generate Pembagian Tugas
                            </button>
                        </div>
                    </div>
                    <div id="assignmentsList"></div>
                </div>
            </div>

            <!-- Archive Page -->
            <div id="archivePage" class="page" style="display: none;">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-archive me-2"></i>Arsip Tugas</h3>
                        <p class="text-muted mb-0">Tugas yang sudah terlewat atau selesai</p>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select class="form-select" id="archiveFilter" onchange="filterArchivedTasks()">
                                <option value="all">Semua Tugas</option>
                                <option value="overdue">Terlewat</option>
                                <option value="completed">Selesai</option>
                                <option value="manual">Diarsip Manual</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="archiveSearch" placeholder="Cari tugas..." onkeyup="searchArchivedTasks()">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-danger w-100" onclick="clearArchive()">
                                <i class="fas fa-trash me-2"></i>Kosongkan Arsip
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Arsip berisi <span id="archiveCount">0</span> tugas. Tugas diarsip otomatis ketika terlewat atau bisa diarsip manual.
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Tugas</th>
                                    <th>Kategori</th>
                                    <th>Status</th>
                                    <th>Deadline</th>
                                    <th>Alasan Arsip</th>
                                    <th>Tanggal Arsip</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="archivedTasksList"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4">
                        <h5><i class="fas fa-chart-bar me-2"></i>Statistik Arsip</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3 id="overdueCount">0</h3>
                                        <p class="text-muted">Terlewat</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3 id="completedCount">0</h3>
                                        <p class="text-muted">Selesai</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3 id="thisMonthCount">0</h3>
                                        <p class="text-muted">Arsip Bulan Ini</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h3 id="oldestArchive">-</h3>
                                        <p class="text-muted">Arsip Tertua</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Page -->
            <div id="chatPage" class="page" style="display: none;">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-comments me-2"></i>Chat Tim</h3>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select" id="messageType" onchange="updateRecipientSelect()">
                                <option value="public">Pesan Umum</option>
                                <option value="private">Pesan Pribadi</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="messageRecipient" style="display: none;">
                                <option value="">Pilih Penerima</option>
                            </select>
                        </div>
                    </div>
                    <div class="chat-container mb-3" id="chatContainer"></div>
                    <form onsubmit="sendMessage(event)">
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageInput" placeholder="Ketik pesan..." required>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> Kirim
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Activity History Page -->
            <div id="activityPage" class="page" style="display: none;">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-history me-2"></i>Riwayat Aktivitas</h3>
                        <p class="text-muted mb-0">Log semua aktivitas dalam tim</p>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="activity-stats">
                        <div class="stat-card">
                            <i class="fas fa-clock text-info"></i>
                            <h4 id="activityToday">0</h4>
                            <p>Hari Ini</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-tasks text-success"></i>
                            <h4 id="activityTasks">0</h4>
                            <p>Aktivitas Tugas</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-users text-warning"></i>
                            <h4 id="activityMembers">0</h4>
                            <p>Aktivitas Anggota</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-user text-primary"></i>
                            <h4 id="activityMy">0</h4>
                            <p>Aktivitas Saya</p>
                        </div>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="activity-filter">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <select class="form-select" id="activityTypeFilter" onchange="filterActivities()">
                                    <option value="all">Semua Jenis</option>
                                    <option value="task">Tugas</option>
                                    <option value="member">Anggota</option>
                                    <option value="assignment">Penugasan</option>
                                    <option value="chat">Chat</option>
                                    <option value="system">System</option>
                                    <option value="archive">Arsip</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select" id="activityUserFilter" onchange="filterActivities()">
                                    <option value="all">Semua User</option>
                                    <option value="me">Hanya Saya</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select" id="activityTimeFilter" onchange="filterActivities()">
                                    <option value="all">Semua Waktu</option>
                                    <option value="today">Hari Ini</option>
                                    <option value="week">Minggu Ini</option>
                                    <option value="month">Bulan Ini</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-success w-100" onclick="exportActivities()">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="activitySearch" 
                                       placeholder="Cari aktivitas..." onkeyup="searchActivities()">
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-danger" onclick="clearActivities()">
                                    <i class="fas fa-trash me-2"></i>Hapus Riwayat
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Timeline -->
                    <div id="activitiesList" class="activity-timeline"></div>
                    
                    <!-- Empty State -->
                    <div id="emptyActivities" class="text-center py-5" style="display: none;">
                        <i class="fas fa-history fa-3x mb-3 text-muted"></i>
                        <h5>Belum ada aktivitas</h5>
                        <p class="text-muted">Aktivitas akan tercatat di sini</p>
                    </div>
                    
                    <!-- Load More Button -->
                    <div class="text-center mt-4" id="loadMoreContainer" style="display: none;">
                        <button class="btn btn-outline-success" onclick="loadMoreActivities()">
                            <i class="fas fa-arrow-down me-2"></i>Muat Lebih Banyak
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page" style="display: none;">
                <div class="content-card">
                    <div class="page-header">
                        <h3><i class="fas fa-user me-2"></i>Profil Saya</h3>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <form onsubmit="updateProfile(event)">
                                <div class="mb-3">
                                    <label class="form-label">Nama Lengkap</label>
                                    <input type="text" class="form-control" id="profileName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profileEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password Baru (Kosongkan jika tidak ingin mengubah)</label>
                                    <input type="password" class="form-control" id="profilePassword" minlength="6">
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Simpan Perubahan
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal fade task-detail-modal" id="taskDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-tasks me-2"></i>Detail Tugas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="taskDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Tutup
                    </button>
                    <button type="button" class="btn btn-primary" id="editTaskDetailBtn">
                        <i class="fas fa-edit me-2"></i>Edit Tugas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Task Modal -->
    <div class="modal fade assign-modal" id="assignTaskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Penugasan Tugas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 id="assignTaskName" class="mb-3"></h6>
                    <p class="text-muted">Pilih anggota yang akan ditugaskan:</p>
                    
                    <div class="assign-member-list" id="assignMemberList">
                        <!-- Daftar anggota akan dimuat di sini -->
                    </div>
                    
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="assignAllMembers">
                            <label class="form-check-label" for="assignAllMembers">
                                Pilih semua anggota
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Batal
                    </button>
                    <button type="button" class="btn btn-success" id="confirmAssignBtn">
                        <i class="fas fa-user-check me-2"></i>Tetapkan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div class="modal fade delete-modal" id="adminModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-shield me-2"></i>Admin Panel - Kelola Anggota
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-users text-primary"></i>
                                <h4 id="adminTotalUsers">0</h4>
                                <p>Total Anggota</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-crown text-warning"></i>
                                <h4 id="adminTotalAdmins">0</h4>
                                <p>Admin</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-user-check text-success"></i>
                                <h4 id="adminActiveUsers">0</h4>
                                <p>Aktif</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card-small">
                                <i class="fas fa-clock text-info"></i>
                                <h4 id="adminInactiveUsers">0</h4>
                                <p>Nonaktif</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filters -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="adminSearch" 
                                   placeholder="Cari anggota..." onkeyup="filterAdminUsers()">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="adminFilterRole" onchange="filterAdminUsers()">
                                <option value="all">Semua Role</option>
                                <option value="admin">Admin</option>
                                <option value="member">Anggota</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="adminFilterStatus" onchange="filterAdminUsers()">
                                <option value="all">Semua Status</option>
                                <option value="active">Aktif</option>
                                <option value="inactive">Nonaktif</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover admin-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Bergabung</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersTable">
                                <!-- Data akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="adminEmptyState" class="text-center py-4" style="display: none;">
                        <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                        <h5>Tidak ada anggota</h5>
                        <p class="text-muted">Belum ada anggota yang terdaftar</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Tutup
                    </button>
                    <button type="button" class="btn btn-primary" onclick="exportAdminData()">
                        <i class="fas fa-download me-2"></i>Export Data
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearAllMembers()">
                        <i class="fas fa-trash-alt me-2"></i>Reset Semua
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Member Modal -->
    <div class="modal fade delete-modal" id="deleteMemberModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Konfirmasi Penghapusan
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-user-slash fa-4x text-danger mb-4"></i>
                    <h4 class="mb-3">Hapus Anggota?</h4>
                    <p id="deleteMemberName" class="h5"></p>
                    <p id="deleteMemberEmail" class="text-muted"></p>
                    
                    <div class="alert alert-warning mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Perhatian!</strong> Tindakan ini akan:
                        <ul class="mb-0 mt-2">
                            <li>Menghapus anggota dari tim</li>
                            <li>Menghapus semua tugas yang ditugaskan</li>
                            <li>Menghapus semua pesan dari anggota</li>
                            <li>Membatalkan semua penugasan terkait</li>
                        </ul>
                    </div>
                    
                    <div class="form-check mt-4 text-start">
                        <input class="form-check-input" type="checkbox" id="confirmDeleteCheck">
                        <label class="form-check-label" for="confirmDeleteCheck">
                            Saya mengerti dan ingin melanjutkan
                        </label>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Batal
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteMemberBtn" disabled>
                        <i class="fas fa-trash me-2"></i>Ya, Hapus Permanen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('tasksmate_users')) || [];
        let tasks = JSON.parse(localStorage.getItem('tasksmate_tasks')) || [];
        let members = JSON.parse(localStorage.getItem('tasksmate_members')) || [];
        let messages = JSON.parse(localStorage.getItem('tasksmate_messages')) || [];
        let assignments = JSON.parse(localStorage.getItem('tasksmate_assignments')) || [];
        let archivedTasks = JSON.parse(localStorage.getItem('tasksmate_archived_tasks')) || [];
        let activities = JSON.parse(localStorage.getItem('tasksmate_activities')) || [];
        
        // Admin emails
        let adminEmails = ['admin@tasksmate.com', 'rizqimaulana0406@gmail.com'];
        
        // Activity types
        const ACTIVITY_TYPES = {
            TASK_CREATED: 'task_created',
            TASK_UPDATED: 'task_updated',
            TASK_DELETED: 'task_deleted',
            TASK_STATUS_CHANGED: 'task_status_changed',
            TASK_ARCHIVED: 'task_archived',
            MEMBER_ADDED: 'member_added',
            MEMBER_DELETED: 'member_deleted',
            ASSIGNMENT_GENERATED: 'assignment_generated',
            ASSIGNMENT_ADDED: 'assignment_added',
            ASSIGNMENT_REMOVED: 'assignment_removed',
            CHAT_MESSAGE: 'chat_message',
            SYSTEM: 'system',
            LOGIN: 'login',
            LOGOUT: 'logout',
            PROFILE_UPDATED: 'profile_updated',
            SUBTASK_COMPLETED: 'subtask_completed',
            SUBTASK_CREATED: 'subtask_created'
        };
        
        // Activity icons
        const ACTIVITY_ICONS = {
            task_created: 'fas fa-plus-circle',
            task_updated: 'fas fa-edit',
            task_deleted: 'fas fa-trash',
            task_status_changed: 'fas fa-exchange-alt',
            task_archived: 'fas fa-archive',
            member_added: 'fas fa-user-plus',
            member_deleted: 'fas fa-user-minus',
            assignment_generated: 'fas fa-magic',
            assignment_added: 'fas fa-user-check',
            assignment_removed: 'fas fa-user-times',
            chat_message: 'fas fa-comment',
            system: 'fas fa-cog',
            login: 'fas fa-sign-in-alt',
            logout: 'fas fa-sign-out-alt',
            profile_updated: 'fas fa-user-edit',
            subtask_completed: 'fas fa-check-circle',
            subtask_created: 'fas fa-list-check'
        };
        
        // Activity colors
        const ACTIVITY_COLORS = {
            task_created: 'success',
            task_updated: 'info',
            task_deleted: 'danger',
            task_status_changed: 'warning',
            task_archived: 'warning',
            member_added: 'success',
            member_deleted: 'danger',
            assignment_generated: 'success',
            assignment_added: 'info',
            assignment_removed: 'warning',
            chat_message: 'info',
            system: 'system',
            login: 'success',
            logout: 'warning',
            profile_updated: 'info',
            subtask_completed: 'success',
            subtask_created: 'info'
        };

        // Simple hash function
        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Log activity function
        function logActivity(type, details, data = null) {
            const activity = {
                id: Date.now(),
                type: type,
                user: currentUser ? currentUser.name : 'System',
                userId: currentUser ? currentUser.id : null,
                details: details,
                data: data,
                timestamp: new Date().toISOString(),
                ipAddress: '127.0.0.1',
                browser: navigator.userAgent.substring(0, 50)
            };
            
            activities.unshift(activity);
            localStorage.setItem('tasksmate_activities', JSON.stringify(activities));
            
            // Update dashboard if visible
            updateDashboard();
        }

        // Check session on load
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                checkSession();
            }, 1000);
        }

        function checkSession() {
            const session = localStorage.getItem('tasksmate_session');
            if (session) {
                currentUser = JSON.parse(session);
                showApp();
                logActivity(ACTIVITY_TYPES.LOGIN, 'User logged in to the system');
                checkOverdueTasks();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
            showLogin();
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userWelcome').textContent = `Halo, ${currentUser.name}!`;
            
            // Update sidebar user info
            document.getElementById('sidebarUserName').textContent = currentUser.name;
            document.getElementById('sidebarUserEmail').textContent = currentUser.email;
            document.getElementById('sidebarUserRole').innerHTML = `<small>Role: ${currentUser.isAdmin ? 'Admin' : 'Member'}</small>`;
            
            const adminMenu = document.getElementById('adminMenuButton');
            if (currentUser.isAdmin || adminEmails.includes(currentUser.email.toLowerCase())) {
                adminMenu.style.display = 'block';
            }
            
            loadProfileData();
            updateDashboard();
            loadTasks();
            loadMembersTable();
            loadMessages();
            updateRecipientSelect();
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'flex';
            document.getElementById('forgotPasswordForm').style.display = 'none';
        }

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'flex';
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (password !== confirmPassword) {
                alert('Password tidak cocok!');
                return;
            }

            if (users.find(u => u.email === email)) {
                alert('Email sudah terdaftar!');
                return;
            }

            const isAdmin = adminEmails.includes(email.toLowerCase());
            const now = new Date().toISOString();

            const user = {
                id: Date.now(),
                name: name,
                email: email,
                password: hashPassword(password),
                isAdmin: isAdmin,
                isActive: true,
                lastLogin: now,
                createdAt: now,
                role: isAdmin ? 'admin' : 'member',
                permissions: isAdmin ? ['admin', 'delete', 'edit', 'view'] : ['view'],
                loginCount: 0
            };

            users.push(user);
            localStorage.setItem('tasksmate_users', JSON.stringify(users));
            
            if (!isAdmin) {
                const newMember = {
                    id: user.id,
                    name: name,
                    email: email,
                    position: '',
                    strength: '',
                    weakness: [],
                    softSkills: [],
                    hardSkills: [],
                    notes: '',
                    addedBy: 'System',
                    createdAt: now
                };
                
                members.push(newMember);
                localStorage.setItem('tasksmate_members', JSON.stringify(members));
            }
            
            logActivity(ACTIVITY_TYPES.MEMBER_ADDED, 
                `User mendaftar: "${name}" ${isAdmin ? '(sebagai admin)' : ''}`, 
                { userId: user.id, userName: name, isAdmin: isAdmin }
            );
            
            alert(isAdmin ? ' Registrasi berhasil! Anda terdaftar sebagai Admin.' : ' Registrasi berhasil! Silakan login.');
            showLogin();
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;

            const user = users.find(u => u.email === email && u.password === hashPassword(password));

            if (user) {
                user.lastLogin = new Date().toISOString();
                user.loginCount = (user.loginCount || 0) + 1;
                user.isActive = true;
                
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex] = user;
                    localStorage.setItem('tasksmate_users', JSON.stringify(users));
                }
                
                currentUser = user;
                if (remember) {
                    localStorage.setItem('tasksmate_session', JSON.stringify(user));
                } else {
                    sessionStorage.setItem('tasksmate_session', JSON.stringify(user));
                }
                
                logActivity(ACTIVITY_TYPES.LOGIN, 'Successful login to the system');
                showApp();
            } else {
                alert('Email atau password salah!');
            }
        }

        function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            const user = users.find(u => u.email === email);

            if (user) {
                alert('Link reset password telah dikirim ke email Anda! (Simulasi)');
                showLogin();
            } else {
                alert('Email tidak ditemukan!');
            }
        }

        function handleLogout() {
            if (confirm('Yakin ingin keluar dari akun Anda?')) {
                if (currentUser) {
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1) {
                        users[userIndex].isActive = false;
                        localStorage.setItem('tasksmate_users', JSON.stringify(users));
                    }
                }
                
                logActivity(ACTIVITY_TYPES.LOGOUT, 'User logged out from the system');
                localStorage.removeItem('tasksmate_session');
                sessionStorage.removeItem('tasksmate_session');
                currentUser = null;
                showAuth();
            }
        }

        function loadProfileData() {
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileEmail').value = currentUser.email;
        }

        function updateProfile(e) {
            e.preventDefault();
            const name = document.getElementById('profileName').value;
            const email = document.getElementById('profileEmail').value;
            const password = document.getElementById('profilePassword').value;

            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].email = email;
                if (password) {
                    users[userIndex].password = hashPassword(password);
                }
                currentUser = users[userIndex];
                localStorage.setItem('tasksmate_users', JSON.stringify(users));
                localStorage.setItem('tasksmate_session', JSON.stringify(currentUser));
                
                // Update sidebar info
                document.getElementById('sidebarUserName').textContent = currentUser.name;
                document.getElementById('sidebarUserEmail').textContent = currentUser.email;
                document.getElementById('userWelcome').textContent = `Halo, ${currentUser.name}!`;
                
                logActivity(ACTIVITY_TYPES.PROFILE_UPDATED, 'Updated profile information');
                
                alert('Profil berhasil diperbarui!');
            }
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            
            if (page === 'dashboard') {
                document.getElementById('dashboardPage').style.display = 'block';
                updateDashboard();
                document.querySelector('.sidebar-menu a[onclick*="dashboard"]').classList.add('active');
            } else if (page === 'tasks') {
                document.getElementById('tasksPage').style.display = 'block';
                loadTasks();
                loadAssignMembersSelect();
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('taskDeadline').value = nextWeek.toISOString().split('T')[0];
                document.querySelector('.sidebar-menu a[onclick*="tasks"]').classList.add('active');
            } else if (page === 'members') {
                document.getElementById('membersPage').style.display = 'block';
                loadMembersTable();
                document.querySelector('.sidebar-menu a[onclick*="members"]').classList.add('active');
            } else if (page === 'assignments') {
                document.getElementById('assignmentsPage').style.display = 'block';
                loadAssignments();
                document.querySelector('.sidebar-menu a[onclick*="assignments"]').classList.add('active');
            } else if (page === 'archive') {
                document.getElementById('archivePage').style.display = 'block';
                loadArchivedTasks();
                updateArchiveStats();
                document.querySelector('.sidebar-menu a[onclick*="archive"]').classList.add('active');
            } else if (page === 'chat') {
                document.getElementById('chatPage').style.display = 'block';
                loadMessages();
                document.querySelector('.sidebar-menu a[onclick*="chat"]').classList.add('active');
            } else if (page === 'activity') {
                document.getElementById('activityPage').style.display = 'block';
                loadActivities();
                updateActivityStats();
                document.querySelector('.sidebar-menu a[onclick*="activity"]').classList.add('active');
            } else if (page === 'profile') {
                document.getElementById('profilePage').style.display = 'block';
                loadProfileData();
                document.querySelector('.sidebar-menu a[onclick*="profile"]').classList.add('active');
            }
        }

        function updateDashboard() {
            const activeTasks = tasks.filter(t => !t.isArchived);
            const overdueTasks = activeTasks.filter(t => {
                const today = new Date();
                const deadline = new Date(t.deadline);
                return deadline < today;
            });
            
            const completedTasks = activeTasks.filter(t => t.status === 'completed').length;
            
            document.getElementById('totalTasks').textContent = activeTasks.length;
            document.getElementById('overdueTasks').textContent = overdueTasks.length;
            document.getElementById('archivedCount').textContent = archivedTasks.length;
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('totalMessages').textContent = messages.length;
            document.getElementById('totalAssignments').textContent = assignments.length;
            document.getElementById('completedTasks').textContent = completedTasks;
            
            const today = new Date().toDateString();
            const todayActivities = activities.filter(act => 
                new Date(act.timestamp).toDateString() === today
            ).length;
            document.getElementById('todayActivities').textContent = todayActivities;
            
            checkOverdueTasks();
        }

        function loadAssignMembersSelect() {
            const select = document.getElementById('taskAssignedTo');
            select.innerHTML = '<option value="" disabled>Pilih Anggota (Bisa lebih dari satu)</option>';
            
            if (members.length === 0) {
                select.innerHTML += '<option value="" disabled>Tidak ada anggota tersedia</option>';
                return;
            }
            
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                select.appendChild(option);
            });
        }

        function addTask(e) {
            e.preventDefault();
            const taskName = document.getElementById('taskInput').value;
            const taskDeadline = document.getElementById('taskDeadline').value;
            const taskPriority = document.getElementById('taskPriority').value;
            const taskCategory = document.getElementById('taskCategory').value;
            const taskAssignedTo = Array.from(document.getElementById('taskAssignedTo').selectedOptions).map(option => option.value);
            const taskSubtasks = document.getElementById('taskSubtasks').value.split('\n').map(s => s.trim()).filter(s => s);
            
            const today = new Date().toISOString().split('T')[0];
            if (taskDeadline < today) {
                if (!confirm('Deadline sudah lewat. Tetap tambahkan tugas?')) {
                    return;
                }
            }
            
            const newTask = {
                id: Date.now(),
                name: taskName,
                deadline: taskDeadline,
                priority: taskPriority,
                category: taskCategory || 'uncategorized',
                status: 'pending',
                assignedTo: taskAssignedTo,
                subtasks: taskSubtasks.map((subtask, index) => ({
                    id: index + 1,
                    name: subtask,
                    completed: false,
                    completedBy: null,
                    completedAt: null
                })),
                createdBy: currentUser.name,
                createdAt: new Date().toISOString(),
                isOverdue: false
            };
            
            tasks.push(newTask);
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            
            if (taskAssignedTo.length > 0) {
                taskAssignedTo.forEach(memberName => {
                    const member = members.find(m => m.name === memberName);
                    if (member) {
                        const assignment = {
                            id: Date.now() + Math.random(),
                            taskId: newTask.id,
                            taskName: taskName,
                            memberId: member.id,
                            memberName: memberName,
                            assignedBy: currentUser.name,
                            assignedAt: new Date().toISOString(),
                            status: 'pending'
                        };
                        
                        assignments.push(assignment);
                    }
                });
                localStorage.setItem('tasksmate_assignments', JSON.stringify(assignments));
            }
            
            logActivity(ACTIVITY_TYPES.TASK_CREATED, 
                `Membuat tugas baru: "${taskName}" (Ditugaskan ke: ${taskAssignedTo.join(', ') || 'Belum ditugaskan'})`, 
                { 
                    taskId: newTask.id, 
                    taskName, 
                    deadline: taskDeadline,
                    assignedTo: taskAssignedTo,
                    subtaskCount: taskSubtasks.length
                }
            );
            
            document.getElementById('taskInput').value = '';
            document.getElementById('taskDeadline').value = '';
            document.getElementById('taskSubtasks').value = '';
            document.getElementById('taskAssignedTo').selectedIndex = -1;
            loadTasks();
            updateDashboard();
            alert('Tugas berhasil ditambahkan!');
        }

        function loadTasks() {
            const tbody = document.getElementById('tasksList');
            tbody.innerHTML = '';
            
            const activeTasks = tasks.filter(task => !task.isArchived);
            
            if (activeTasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <i class="fas fa-tasks fa-2x mb-2"></i><br>
                            Belum ada tugas. Tambahkan tugas baru!
                        </td>
                    </tr>
                `;
                return;
            }
            
            activeTasks.forEach((task, index) => {
                let priorityClass = 'priority-low';
                let priorityText = 'Rendah';
                if (task.priority === 'medium') {
                    priorityClass = 'priority-medium';
                    priorityText = 'Sedang';
                } else if (task.priority === 'high') {
                    priorityClass = 'priority-high';
                    priorityText = 'Tinggi';
                }
                
                const today = new Date();
                const deadline = new Date(task.deadline);
                const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                let deadlineStatus = '';
                let deadlineClass = '';
                
                if (daysLeft < 0) {
                    deadlineStatus = `<span class="badge bg-danger">Terlewat ${Math.abs(daysLeft)} hari</span>`;
                    deadlineClass = 'text-danger fw-bold';
                } else if (daysLeft === 0) {
                    deadlineStatus = '<span class="badge bg-warning text-dark">Hari ini</span>';
                    deadlineClass = 'text-warning fw-bold';
                } else if (daysLeft <= 3) {
                    deadlineStatus = `<span class="badge bg-warning text-dark">${daysLeft} hari lagi</span>`;
                    deadlineClass = 'text-warning';
                } else {
                    deadlineStatus = `<span class="badge bg-success">${daysLeft} hari lagi</span>`;
                    deadlineClass = 'text-success';
                }
                
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                if (task.status === 'in-progress') {
                    statusClass = 'status-in-progress';
                    statusText = 'In Progress';
                } else if (task.status === 'completed') {
                    statusClass = 'status-completed';
                    statusText = 'Selesai';
                }
                
                let assignedMembersHTML = '<div class="task-assignees">';
                if (task.assignedTo && task.assignedTo.length > 0) {
                    task.assignedTo.forEach(memberName => {
                        assignedMembersHTML += `<span class="task-assignee-badge"><i class="fas fa-user"></i> ${memberName}</span>`;
                    });
                } else {
                    assignedMembersHTML += '<span class="text-muted">Belum ditugaskan</span>';
                }
                assignedMembersHTML += '</div>';
                
                const completedSubtasks = task.subtasks ? task.subtasks.filter(st => st.completed).length : 0;
                const totalSubtasks = task.subtasks ? task.subtasks.length : 0;
                const progress = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;
                
                let subtasksHTML = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    subtasksHTML = `
                        <div class="subtask-list">
                            ${task.subtasks.slice(0, 2).map((subtask, idx) => `
                                <div class="form-check mb-1">
                                    <input class="form-check-input subtask-checkbox" 
                                           type="checkbox" 
                                           ${subtask.completed ? 'checked' : ''}
                                           onchange="toggleSubtask(${task.id}, ${subtask.id}, this.checked)"
                                           id="subtask_${task.id}_${subtask.id}">
                                    <label class="form-check-label ${subtask.completed ? 'text-decoration-line-through text-muted' : ''}" 
                                           for="subtask_${task.id}_${subtask.id}">
                                        ${subtask.name}
                                    </label>
                                </div>
                            `).join('')}
                            ${task.subtasks.length > 2 ? `
                                <button class="btn btn-sm btn-link p-0" onclick="viewTaskDetails(${task.id})">
                                    <small>+${task.subtasks.length - 2} pekerjaan lainnya</small>
                                </button>
                            ` : ''}
                            <div class="mt-2">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: ${progress}%" 
                                         aria-valuenow="${progress}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted">${completedSubtasks}/${totalSubtasks} selesai</small>
                            </div>
                        </div>
                    `;
                } else {
                    subtasksHTML = '<small class="text-muted">Tidak ada detail</small>';
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <strong>${task.name}</strong>
                            ${task.category ? `<br><small class="text-muted">${task.category}</small>` : ''}
                        </td>
                        <td>${subtasksHTML}</td>
                        <td><span class="status-badge ${priorityClass}">${priorityText}</span></td>
                        <td class="${deadlineClass}">
                            ${new Date(task.deadline).toLocaleDateString('id-ID')}
                            <br>${deadlineStatus}
                        </td>
                        <td>${assignedMembersHTML}</td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateTaskStatus(${task.id}, this.value)">
                                <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Selesai</option>
                            </select>
                        </td>
                        <td>${task.createdBy}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-info" onclick="editTaskWithDetails(${task.id})" title="Edit Detail">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="assignTaskToMembers(${task.id})" title="Tetapkan Anggota">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="viewTaskDetails(${task.id})" title="Lihat Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function viewTaskDetails(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const completedSubtasks = task.subtasks ? task.subtasks.filter(st => st.completed).length : 0;
            const totalSubtasks = task.subtasks ? task.subtasks.length : 0;
            const progress = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;
            
            let subtasksHTML = '';
            if (task.subtasks && task.subtasks.length > 0) {
                subtasksHTML = task.subtasks.map(subtask => `
                    <div class="subtask-item ${subtask.completed ? 'completed' : ''}">
                        <div class="subtask-check">
                            <input class="form-check-input" type="checkbox" 
                                   ${subtask.completed ? 'checked disabled' : ''}
                                   onchange="toggleSubtask(${task.id}, ${subtask.id}, this.checked)"
                                   id="detail_subtask_${subtask.id}">
                        </div>
                        <div class="subtask-content">
                            <label class="form-check-label ${subtask.completed ? 'text-decoration-line-through text-muted' : ''}" 
                                   for="detail_subtask_${subtask.id}">
                                ${subtask.name}
                            </label>
                            ${subtask.completed ? `
                                <div class="subtask-meta">
                                    <small>Selesai oleh: ${subtask.completedBy} pada ${new Date(subtask.completedAt).toLocaleDateString('id-ID')}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                subtasksHTML = '<p class="text-muted">Tidak ada sub-tugas</p>';
            }
            
            const assignedMembers = task.assignedTo && task.assignedTo.length > 0 ? 
                task.assignedTo.map(name => `<span class="badge bg-success me-1">${name}</span>`).join('') : 
                '<span class="text-muted">Belum ditugaskan</span>';
            
            const html = `
                <h5>${task.name}</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Kategori:</strong> ${task.category || '-'}</p>
                        <p><strong>Prioritas:</strong> <span class="status-badge ${task.priority === 'high' ? 'priority-high' : task.priority === 'medium' ? 'priority-medium' : 'priority-low'}">${task.priority}</span></p>
                        <p><strong>Dibuat oleh:</strong> ${task.createdBy}</p>
                        <p><strong>Tanggal dibuat:</strong> ${new Date(task.createdAt).toLocaleDateString('id-ID')}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Deadline:</strong> ${new Date(task.deadline).toLocaleDateString('id-ID')}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${task.status === 'completed' ? 'status-completed' : task.status === 'in-progress' ? 'status-in-progress' : 'status-pending'}">${task.status}</span></p>
                        <p><strong>Ditugaskan ke:</strong> <br>${assignedMembers}</p>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-list-check me-2"></i>Daftar Pekerjaan (${completedSubtasks}/${totalSubtasks})</h6>
                    </div>
                    <div class="card-body">
                        ${subtasksHTML}
                    </div>
                </div>
                
                ${totalSubtasks > 0 ? `
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: ${progress}%">
                            ${progress}% Selesai
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('taskDetailContent').innerHTML = html;
            document.getElementById('editTaskDetailBtn').onclick = function() {
                editTaskWithDetails(taskId);
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskDetailModal'));
                modal.hide();
            };
            
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();
        }

        function toggleSubtask(taskId, subtaskId, completed) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.subtasks) return;
            
            const subtask = task.subtasks.find(st => st.id === subtaskId);
            if (subtask) {
                subtask.completed = completed;
                subtask.completedBy = completed ? currentUser.name : null;
                subtask.completedAt = completed ? new Date().toISOString() : null;
                
                if (task.subtasks.every(st => st.completed)) {
                    task.status = 'completed';
                }
                
                localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
                loadTasks();
                updateDashboard();
                
                logActivity(ACTIVITY_TYPES.SUBTASK_COMPLETED, 
                    `${completed ? 'Menyelesaikan' : 'Membatalkan'} subtask "${subtask.name}" dari tugas "${task.name}"`,
                    { taskId, taskName: task.name, subtaskId, subtaskName: subtask.name, completed }
                );
            }
        }

        function editTaskWithDetails(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            let newName = prompt('Edit nama tugas:', task.name);
            if (newName && newName.trim() !== '') {
                task.name = newName.trim();
            }
            
            let currentSubtasks = task.subtasks ? task.subtasks.map(st => st.name).join('\n') : '';
            let newSubtasks = prompt('Edit daftar pekerjaan (pisahkan dengan baris baru):', currentSubtasks);
            
            if (newSubtasks !== null) {
                const subtaskArray = newSubtasks.split('\n').map(s => s.trim()).filter(s => s);
                task.subtasks = subtaskArray.map((subtask, index) => {
                    const existingSubtask = task.subtasks ? task.subtasks.find(st => st.name === subtask) : null;
                    
                    return {
                        id: index + 1,
                        name: subtask,
                        completed: existingSubtask ? existingSubtask.completed : false,
                        completedBy: existingSubtask ? existingSubtask.completedBy : null,
                        completedAt: existingSubtask ? existingSubtask.completedAt : null
                    };
                });
                
                logActivity(ACTIVITY_TYPES.SUBTASK_CREATED, 
                    `Mengedit daftar pekerjaan untuk tugas "${task.name}"`,
                    { taskId, taskName: task.name, subtaskCount: subtaskArray.length }
                );
            }
            
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            loadTasks();
            alert('Tugas berhasil diperbarui!');
        }

        let currentAssignTaskId = null;

        function assignTaskToMembers(taskId) {
            currentAssignTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) {
                alert('Tugas tidak ditemukan!');
                return;
            }
            
            document.getElementById('assignTaskName').textContent = `"${task.name}"`;
            
            const memberList = document.getElementById('assignMemberList');
            memberList.innerHTML = '';
            
            if (members.length === 0) {
                memberList.innerHTML = '<p class="text-muted text-center">Tidak ada anggota tersedia</p>';
                return;
            }
            
            members.forEach(member => {
                const isAssigned = task.assignedTo && task.assignedTo.includes(member.name);
                
                const memberDiv = document.createElement('div');
                memberDiv.className = `assign-member-item ${isAssigned ? 'selected' : ''}`;
                memberDiv.innerHTML = `
                    <input type="checkbox" class="assign-member-checkbox" 
                           id="member_${member.id}" 
                           ${isAssigned ? 'checked' : ''}
                           value="${member.name}">
                    <label for="member_${member.id}" class="flex-grow-1">
                        <strong>${member.name}</strong>
                        ${member.position ? `<br><small class="text-muted">${member.position}</small>` : ''}
                    </label>
                    ${isAssigned ? '<span class="assigned-badge">Sudah ditugaskan</span>' : ''}
                `;
                
                memberList.appendChild(memberDiv);
            });
            
            document.getElementById('assignAllMembers').onchange = function() {
                const checkboxes = document.querySelectorAll('.assign-member-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const memberItem = checkbox.closest('.assign-member-item');
                    if (this.checked) {
                        memberItem.classList.add('selected');
                    } else {
                        memberItem.classList.remove('selected');
                    }
                });
            };
            
            const checkboxes = document.querySelectorAll('.assign-member-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.onchange = function() {
                    const memberItem = this.closest('.assign-member-item');
                    if (this.checked) {
                        memberItem.classList.add('selected');
                    } else {
                        memberItem.classList.remove('selected');
                    }
                };
            });
            
            document.getElementById('confirmAssignBtn').onclick = confirmAssignment;
            
            const modal = new bootstrap.Modal(document.getElementById('assignTaskModal'));
            modal.show();
        }

        function confirmAssignment() {
            if (!currentAssignTaskId) return;
            
            const task = tasks.find(t => t.id === currentAssignTaskId);
            if (!task) return;
            
            const selectedMembers = [];
            const checkboxes = document.querySelectorAll('.assign-member-checkbox:checked');
            checkboxes.forEach(checkbox => {
                selectedMembers.push(checkbox.value);
            });
            
            const previousAssignments = task.assignedTo || [];
            
            task.assignedTo = selectedMembers;
            
            assignments = assignments.filter(a => a.taskId !== task.id);
            
            selectedMembers.forEach(memberName => {
                const member = members.find(m => m.name === memberName);
                if (member) {
                    const assignment = {
                        id: Date.now() + Math.random(),
                        taskId: task.id,
                        taskName: task.name,
                        memberId: member.id,
                        memberName: memberName,
                        assignedBy: currentUser.name,
                        assignedAt: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    assignments.push(assignment);
                    
                    logActivity(ACTIVITY_TYPES.ASSIGNMENT_ADDED,
                        `Menetapkan tugas "${task.name}" ke ${memberName}`,
                        {
                            taskId: task.id,
                            taskName: task.name,
                            memberName: memberName,
                            memberId: member.id
                        }
                    );
                }
            });
            
            const removedAssignments = previousAssignments.filter(name => !selectedMembers.includes(name));
            removedAssignments.forEach(memberName => {
                logActivity(ACTIVITY_TYPES.ASSIGNMENT_REMOVED,
                    `Menghapus penugasan "${task.name}" dari ${memberName}`,
                    {
                        taskId: task.id,
                        taskName: task.name,
                        memberName: memberName
                    }
                );
            });
            
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            localStorage.setItem('tasksmate_assignments', JSON.stringify(assignments));
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignTaskModal'));
            modal.hide();
            
            loadTasks();
            updateDashboard();
            
            if (selectedMembers.length > 0) {
                alert(`Tugas berhasil ditetapkan ke ${selectedMembers.length} anggota!`);
            } else {
                alert('Penugasan tugas telah dihapus!');
            }
            
            currentAssignTaskId = null;
        }

        function updateTaskStatus(taskId, status) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                const oldStatus = tasks[taskIndex].status;
                tasks[taskIndex].status = status;
                localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
                
                logActivity(ACTIVITY_TYPES.TASK_STATUS_CHANGED, 
                    `Mengubah status tugas "${tasks[taskIndex].name}" dari "${oldStatus}" menjadi "${status}"`, 
                    { taskId, taskName: tasks[taskIndex].name, oldStatus, newStatus: status }
                );
                
                loadTasks();
                updateDashboard();
                
                if (status === 'completed') {
                    setTimeout(() => {
                        if (confirm('Tugas telah selesai. Ingin mengarsipkan tugas ini?')) {
                            archiveTask(taskId, 'completed');
                        }
                    }, 500);
                }
            }
        }

        function deleteTask(id) {
            if (confirm('Yakin ingin menghapus tugas ini?')) {
                const task = tasks.find(t => t.id === id);
                tasks = tasks.filter(t => t.id !== id);
                
                assignments = assignments.filter(a => a.taskId !== id);
                
                localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
                localStorage.setItem('tasksmate_assignments', JSON.stringify(assignments));
                
                if (task) {
                    logActivity(ACTIVITY_TYPES.TASK_DELETED, 
                        `Menghapus tugas: "${task.name}"`, 
                        { taskId: id, taskName: task.name }
                    );
                }
                
                loadTasks();
                updateDashboard();
            }
        }

        function checkOverdueTasks() {
            const today = new Date().toISOString().split('T')[0];
            let hasChanges = false;
            
            tasks.forEach(task => {
                if (task.deadline < today && !task.isArchived) {
                    task.isOverdue = true;
                    const deadlineDate = new Date(task.deadline);
                    const todayDate = new Date();
                    const daysOverdue = Math.floor((todayDate - deadlineDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysOverdue >= 3) {
                        archiveTask(task.id, 'auto');
                        hasChanges = true;
                    }
                }
            });
            
            if (hasChanges) {
                localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
                loadTasks();
            }
        }

        function archiveTask(taskId, reason = 'manual') {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = tasks[taskIndex];
            const today = new Date();
            
            archivedTasks.push({
                ...task,
                archivedDate: today.toISOString(),
                archiveReason: reason === 'auto' ? 'Terlewat otomatis' : 
                              reason === 'completed' ? 'Tugas selesai' : 'Diarsip manual',
                archivedBy: currentUser.name
            });
            
            tasks.splice(taskIndex, 1);
            
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            localStorage.setItem('tasksmate_archived_tasks', JSON.stringify(archivedTasks));
            
            logActivity(ACTIVITY_TYPES.TASK_ARCHIVED, 
                `Mengarsipkan tugas: "${task.name}" (Alasan: ${reason})`, 
                { taskId, taskName: task.name, reason }
            );
            
            loadTasks();
            updateDashboard();
            alert('Tugas berhasil diarsip!');
        }

        function loadArchivedTasks(filter = 'all') {
            const tbody = document.getElementById('archivedTasksList');
            tbody.innerHTML = '';
            
            let filteredTasks = archivedTasks;
            
            if (filter === 'overdue') {
                filteredTasks = archivedTasks.filter(task => task.isOverdue);
            } else if (filter === 'completed') {
                filteredTasks = archivedTasks.filter(task => task.status === 'completed');
            } else if (filter === 'manual') {
                filteredTasks = archivedTasks.filter(task => task.archiveReason === 'Diarsip manual');
            }
            
            if (filteredTasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            Tidak ada tugas di arsip.
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredTasks.forEach((task, index) => {
                const archiveDate = new Date(task.archivedDate);
                const deadlineDate = new Date(task.deadline);
                
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                if (task.status === 'in-progress') {
                    statusClass = 'status-in-progress';
                    statusText = 'In Progress';
                } else if (task.status === 'completed') {
                    statusClass = 'status-completed';
                    statusText = 'Selesai';
                }
                
                let assignedMembersHTML = '';
                if (task.assignedTo && task.assignedTo.length > 0) {
                    assignedMembersHTML = task.assignedTo.map(name => 
                        `<span class="task-assignee-badge"><i class="fas fa-user"></i> ${name}</span>`
                    ).join('');
                } else {
                    assignedMembersHTML = '<span class="text-muted">Tidak ada</span>';
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <strong>${task.name}</strong>
                            <br><small class="text-muted">Oleh: ${task.createdBy}</small>
                        </td>
                        <td>${task.category || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="${task.isOverdue ? 'text-danger' : 'text-dark'}">
                            ${deadlineDate.toLocaleDateString('id-ID')}
                            ${task.isOverdue ? '<br><small class="badge bg-danger">Terlewat</small>' : ''}
                        </td>
                        <td>
                            <div>${task.archiveReason}</div>
                            <small>Anggota: ${assignedMembersHTML}</small>
                        </td>
                        <td>${archiveDate.toLocaleDateString('id-ID')}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-success" onclick="restoreFromArchive(${task.id})" title="Kembalikan">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFromArchive(${task.id})" title="Hapus Permanen">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function restoreFromArchive(taskId) {
            if (!confirm('Kembalikan tugas ini ke daftar aktif?')) return;
            
            const taskIndex = archivedTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = archivedTasks[taskIndex];
            
            const { archivedDate, archiveReason, archivedBy, ...restoredTask } = task;
            
            tasks.push(restoredTask);
            archivedTasks.splice(taskIndex, 1);
            
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            localStorage.setItem('tasksmate_archived_tasks', JSON.stringify(archivedTasks));
            
            logActivity(ACTIVITY_TYPES.TASK_UPDATED, 
                `Mengembalikan tugas dari arsip: "${task.name}"`, 
                { taskId, taskName: task.name }
            );
            
            loadArchivedTasks();
            updateDashboard();
            alert('Tugas berhasil dikembalikan!');
        }

        function deleteFromArchive(taskId) {
            if (!confirm('Hapus permanen tugas ini dari arsip?')) return;
            
            const task = archivedTasks.find(t => t.id === taskId);
            archivedTasks = archivedTasks.filter(t => t.id !== taskId);
            localStorage.setItem('tasksmate_archived_tasks', JSON.stringify(archivedTasks));
            
            if (task) {
                logActivity(ACTIVITY_TYPES.TASK_DELETED, 
                    `Menghapus permanen tugas dari arsip: "${task.name}"`, 
                    { taskId, taskName: task.name }
                );
            }
            
            loadArchivedTasks();
            updateArchiveStats();
            alert('Tugas berhasil dihapus permanen!');
        }

        function filterArchivedTasks() {
            const filter = document.getElementById('archiveFilter').value;
            loadArchivedTasks(filter);
        }

        function searchArchivedTasks() {
            const searchTerm = document.getElementById('archiveSearch').value.toLowerCase();
            const tbody = document.getElementById('archivedTasksList');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            }
        }

        function updateArchiveStats() {
            document.getElementById('archiveCount').textContent = archivedTasks.length;
            
            const overdueCount = archivedTasks.filter(t => t.isOverdue).length;
            document.getElementById('overdueCount').textContent = overdueCount;
            
            const completedCount = archivedTasks.filter(t => t.status === 'completed').length;
            document.getElementById('completedCount').textContent = completedCount;
            
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const thisMonthCount = archivedTasks.filter(t => {
                const archiveDate = new Date(t.archivedDate);
                return archiveDate.getMonth() === thisMonth && archiveDate.getFullYear() === thisYear;
            }).length;
            document.getElementById('thisMonthCount').textContent = thisMonthCount;
            
            if (archivedTasks.length > 0) {
                const oldest = archivedTasks.reduce((oldest, current) => {
                    return new Date(current.archivedDate) < new Date(oldest.archivedDate) ? current : oldest;
                });
                const oldestDate = new Date(oldest.archivedDate);
                document.getElementById('oldestArchive').textContent = oldestDate.toLocaleDateString('id-ID');
            } else {
                document.getElementById('oldestArchive').textContent = '-';
            }
        }

        function clearArchive() {
            if (archivedTasks.length === 0) {
                alert('Arsip sudah kosong!');
                return;
            }
            
            if (confirm('Yakin ingin mengosongkan semua arsip? Tindakan ini tidak dapat dibatalkan!')) {
                logActivity(ACTIVITY_TYPES.SYSTEM, 
                    `Mengosongkan arsip: ${archivedTasks.length} tugas dihapus`, 
                    { deletedCount: archivedTasks.length }
                );
                
                archivedTasks = [];
                localStorage.setItem('tasksmate_archived_tasks', JSON.stringify(archivedTasks));
                loadArchivedTasks();
                updateArchiveStats();
                alert('Arsip berhasil dikosongkan!');
            }
        }

        // MODIFIED: Fungsi addMember dengan tambahan kolom kekurangan
        function addMember(e) {
            e.preventDefault();
            const name = document.getElementById('memberName').value;
            const email = document.getElementById('memberEmail').value;
            const strength = document.getElementById('memberStrength').value;
            const weakness = document.getElementById('memberWeakness').value.split(',').map(s => s.trim()).filter(s => s);
            const softSkills = document.getElementById('memberSoftSkills').value.split(',').map(s => s.trim()).filter(s => s);
            const hardSkills = document.getElementById('memberHardSkills').value.split(',').map(s => s.trim()).filter(s => s);
            const notes = document.getElementById('memberNotes').value;

            const newMember = {
                id: Date.now(),
                name: name,
                email: email,
                position: '',
                strength: strength,
                weakness: weakness,
                softSkills: softSkills,
                hardSkills: hardSkills,
                notes: notes,
                addedBy: currentUser.name,
                createdAt: new Date().toISOString()
            };

            members.push(newMember);
            localStorage.setItem('tasksmate_members', JSON.stringify(members));
            
            logActivity(ACTIVITY_TYPES.MEMBER_ADDED, 
                `Menambahkan anggota tim baru: "${name}"`, 
                { memberId: newMember.id, memberName: name }
            );
            
            // Reset form
            document.getElementById('memberName').value = '';
            document.getElementById('memberEmail').value = '';
            document.getElementById('memberStrength').value = '';
            document.getElementById('memberWeakness').value = '';
            document.getElementById('memberSoftSkills').value = '';
            document.getElementById('memberHardSkills').value = '';
            document.getElementById('memberNotes').value = '';
            
            loadMembersTable();
            loadAssignMembersSelect();
            updateDashboard();
            updateRecipientSelect();
            alert('Anggota berhasil ditambahkan!');
        }

        // MODIFIED: Fungsi loadMembersTable dengan tambahan kolom kekurangan dan hapus kolom role
        function loadMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            const emptyState = document.getElementById('membersEmptyState');
            
            if (members.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                updateMembersStats();
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            members.forEach((member, index) => {
                const user = users.find(u => u.name === member.name || u.email === member.email);
                
                // Hitung tugas aktif
                const activeTasks = assignments.filter(a => a.memberId === member.id && 
                    tasks.find(t => t.id === a.taskId && !t.isArchived));
                const taskCount = activeTasks.length;
                
                // Format kelebihan
                const strengthHTML = member.strength ? 
                    `<span class="badge bg-success">${member.strength}</span>` : 
                    '<small class="text-muted">Belum ada</small>';
                
                // Format kekurangan
                const weaknessHTML = member.weakness && member.weakness.length > 0 ? 
                    member.weakness.map(w => `<span class="weakness-badge">${w}</span>`).join('') : 
                    '<small class="text-muted">Belum ada</small>';
                
                // Format skills
                const softSkills = member.softSkills && member.softSkills.length > 0 ? 
                    member.softSkills.map(s => `<span class="skill-badge">${s}</span>`).join('') : 
                    '<small class="text-muted">Belum ada</small>';
                
                const hardSkills = member.hardSkills && member.hardSkills.length > 0 ? 
                    member.hardSkills.map(s => `<span class="skill-badge">${s}</span>`).join('') : 
                    '<small class="text-muted">Belum ada</small>';
                
                const totalSkills = (member.softSkills?.length || 0) + (member.hardSkills?.length || 0);
                
                // Format email
                const email = member.email || '-';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <strong>${member.name}</strong>
                            <div><small class="text-muted">ID: ${member.id}</small></div>
                        </td>
                        <td>${email}</td>
                        <td>${strengthHTML}</td>
                        <td>${weaknessHTML}</td>
                        <td>
                            <div class="mb-1">
                                <small class="text-muted d-block">Soft Skills:</small>
                                <div>${softSkills}</div>
                            </div>
                            <div>
                                <small class="text-muted d-block">Hard Skills:</small>
                                <div>${hardSkills}</div>
                            </div>
                            <small class="text-muted">Total: ${totalSkills} skills</small>
                        </td>
                        <td>
                            <span class="badge ${taskCount > 0 ? 'bg-info' : 'bg-secondary'}">
                                ${taskCount} tugas
                            </span>
                            ${taskCount > 0 ? `
                                <button class="btn btn-sm btn-link p-0 mt-1" 
                                        onclick="viewMemberTasks(${member.id}, '${member.name}')">
                                    <small>Lihat tugas</small>
                                </button>
                            ` : ''}
                        </td>
                        <td>
                            <small>${member.createdAt ? new Date(member.createdAt).toLocaleDateString('id-ID') : '-'}</small>
                            <br><small class="text-muted">Oleh: ${member.addedBy || 'System'}</small>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-info" onclick="editMember(${member.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="viewMemberDetails(${member.id})" title="Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id})" 
                                        title="Hapus" 
                                        ${!currentUser.isAdmin && !adminEmails.includes(currentUser.email.toLowerCase()) ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateMembersStats();
            filterMembersTable();
        }

        // MODIFIED: Fungsi updateMembersStats dengan statistik kelebihan
        function updateMembersStats() {
            document.getElementById('totalMembersCount').textContent = members.length;
            
            const strengthCount = members.filter(member => member.strength && member.strength.trim() !== '').length;
            document.getElementById('strengthCount').textContent = strengthCount;
            
            const totalActiveTasks = members.reduce((total, member) => {
                const memberTasks = assignments.filter(a => a.memberId === member.id && 
                    tasks.find(t => t.id === a.taskId && !t.isArchived));
                return total + memberTasks.length;
            }, 0);
            document.getElementById('activeTasksCount').textContent = totalActiveTasks;
            
            const avgSkills = members.length > 0 ? 
                Math.round(members.reduce((total, member) => {
                    return total + (member.softSkills?.length || 0) + (member.hardSkills?.length || 0);
                }, 0) / members.length) : 0;
            document.getElementById('avgSkillsCount').textContent = avgSkills;
        }

        function filterMembersTable() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            
            const tbody = document.getElementById('membersTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                if (cells.length < 9) continue;
                
                const name = cells[1].textContent.toLowerCase();
                const email = cells[2].textContent.toLowerCase();
                const strength = cells[3].textContent.toLowerCase();
                const weakness = cells[4].textContent.toLowerCase();
                
                let showRow = true;
                
                // Search filter berdasarkan nama, email, kelebihan, dan kekurangan
                if (searchTerm && !name.includes(searchTerm) && !email.includes(searchTerm) && 
                    !strength.includes(searchTerm) && !weakness.includes(searchTerm)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        // MODIFIED: Fungsi viewMemberDetails dengan informasi kekurangan
        function viewMemberDetails(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const user = users.find(u => u.name === member.name);
            const isAdmin = user ? (user.isAdmin || adminEmails.includes(user.email?.toLowerCase())) : false;
            
            const assignedTasks = assignments.filter(a => a.memberId === member.id)
                .map(a => {
                    const task = tasks.find(t => t.id === a.taskId);
                    return task ? task.name : null;
                })
                .filter(name => name);
            
            const details = `
                <strong>Detail Anggota Tim</strong>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Nama:</strong> ${member.name}</p>
                        <p><strong>Email:</strong> ${member.email || '-'}</p>
                        <p><strong>Role:</strong> ${isAdmin ? 'Admin' : 'Member'}</p>
                        <p><strong>Kelebihan:</strong> ${member.strength || '-'}</p>
                        <p><strong>Ditambahkan oleh:</strong> ${member.addedBy || 'System'}</p>
                        <p><strong>Tanggal ditambahkan:</strong> ${member.createdAt ? new Date(member.createdAt).toLocaleDateString('id-ID') : '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Kekurangan:</strong></p>
                        ${member.weakness && member.weakness.length > 0 ? 
                            member.weakness.map(w => `<span class="badge bg-warning me-1 mb-1">${w}</span>`).join('') : '-'}
                        <p class="mt-2"><strong>Soft Skills:</strong></p>
                        ${member.softSkills && member.softSkills.length > 0 ? 
                            member.softSkills.map(s => `<span class="badge bg-info me-1 mb-1">${s}</span>`).join('') : '-'}
                        <p class="mt-2"><strong>Hard Skills:</strong></p>
                        ${member.hardSkills && member.hardSkills.length > 0 ? 
                            member.hardSkills.map(s => `<span class="badge bg-success me-1 mb-1">${s}</span>`).join('') : '-'}
                    </div>
                </div>
                ${member.notes ? `
                    <hr>
                    <p><strong>Catatan:</strong></p>
                    <p>${member.notes}</p>
                ` : ''}
                <hr>
                <p><strong>Tugas yang ditugaskan:</strong> ${assignedTasks.length}</p>
                ${assignedTasks.length > 0 ? 
                    `<ul>${assignedTasks.map(task => `<li>${task}</li>`).join('')}</ul>` : 
                    '<p class="text-muted">Belum ada tugas</p>'
                }
            `;
            
            alert(details);
        }

        function viewMemberTasks(memberId, memberName) {
            const memberTasks = assignments.filter(a => a.memberId === memberId)
                .map(assignment => {
                    const task = tasks.find(t => t.id === assignment.taskId && !t.isArchived);
                    if (!task) return null;
                    
                    return {
                        taskName: task.name,
                        deadline: task.deadline,
                        status: task.status,
                        priority: task.priority
                    };
                })
                .filter(task => task);
            
            if (memberTasks.length === 0) {
                alert(`Tidak ada tugas aktif untuk ${memberName}`);
                return;
            }
            
            let taskList = `<strong>Tugas Aktif ${memberName}:</strong><hr>`;
            memberTasks.forEach((task, index) => {
                const deadline = new Date(task.deadline).toLocaleDateString('id-ID');
                taskList += `
                    <div class="mb-2">
                        <strong>${index + 1}. ${task.taskName}</strong><br>
                        <small>Deadline: ${deadline} | Status: ${task.status} | Prioritas: ${task.priority}</small>
                    </div>
                `;
            });
            
            const modalHtml = `
                <div class="modal fade" id="memberTasksModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-tasks me-2"></i>Tugas ${memberName}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${taskList}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Tambahkan modal ke DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            
            const modal = new bootstrap.Modal(document.getElementById('memberTasksModal'));
            modal.show();
            
            // Hapus modal setelah ditutup
            modalContainer.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modalContainer);
            });
        }

        // MODIFIED: Fungsi editMember dengan tambahan input kekurangan
        function editMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            let newName = prompt('Edit nama:', member.name);
            if (newName !== null) {
                member.name = newName.trim();
            }
            
            let newEmail = prompt('Edit email:', member.email || '');
            if (newEmail !== null) {
                member.email = newEmail.trim();
            }
            
            let newStrength = prompt('Edit kelebihan:', member.strength || '');
            if (newStrength !== null) {
                member.strength = newStrength.trim();
            }
            
            const currentWeakness = member.weakness ? member.weakness.join(', ') : '';
            const newWeakness = prompt('Edit kekurangan (pisahkan dengan koma):', currentWeakness);
            if (newWeakness !== null) {
                member.weakness = newWeakness.split(',').map(s => s.trim()).filter(s => s);
            }
            
            const currentSoftSkills = member.softSkills ? member.softSkills.join(', ') : '';
            const newSoftSkills = prompt('Edit soft skills (pisahkan dengan koma):', currentSoftSkills);
            if (newSoftSkills !== null) {
                member.softSkills = newSoftSkills.split(',').map(s => s.trim()).filter(s => s);
            }
            
            const currentHardSkills = member.hardSkills ? member.hardSkills.join(', ') : '';
            const newHardSkills = prompt('Edit hard skills (pisahkan dengan koma):', currentHardSkills);
            if (newHardSkills !== null) {
                member.hardSkills = newHardSkills.split(',').map(s => s.trim()).filter(s => s);
            }
            
            let newNotes = prompt('Edit catatan tambahan:', member.notes || '');
            if (newNotes !== null) {
                member.notes = newNotes.trim();
            }
            
            member.updatedAt = new Date().toISOString();
            member.updatedBy = currentUser.name;
            
            localStorage.setItem('tasksmate_members', JSON.stringify(members));
            
            logActivity(ACTIVITY_TYPES.MEMBER_ADDED, 
                `Mengedit data anggota: "${member.name}"`, 
                { memberId: member.id, memberName: member.name }
            );
            
            loadMembersTable();
            updateMembersStats();
            loadAssignMembersSelect();
            updateRecipientSelect();
            alert('Data anggota berhasil diperbarui!');
        }

        // MODIFIED: Fungsi exportMembersData dengan tambahan kolom kekurangan
        function exportMembersData() {
            if (members.length === 0) {
                alert('Tidak ada data anggota untuk diexport!');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "No,Nama,Email,Kelebihan,Kekurangan,Soft Skills,Hard Skills,Tugas Aktif,Ditambahkan Oleh,Tanggal Dibuat,Catatan\n";
            
            members.forEach((member, index) => {
                const user = users.find(u => u.name === member.name);
                
                const activeTasks = assignments.filter(a => a.memberId === member.id && 
                    tasks.find(t => t.id === a.taskId && !t.isArchived)).length;
                
                const row = [
                    index + 1,
                    member.name,
                    member.email || '',
                    member.strength || '',
                    member.weakness ? member.weakness.join('; ') : '',
                    member.softSkills ? member.softSkills.join('; ') : '',
                    member.hardSkills ? member.hardSkills.join('; ') : '',
                    activeTasks,
                    member.addedBy || 'System',
                    member.createdAt ? new Date(member.createdAt).toLocaleDateString('id-ID') : '',
                    member.notes || ''
                ].map(field => `"${field}"`).join(",");
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `anggota_tim_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            logActivity(ACTIVITY_TYPES.SYSTEM, 
                `Mengexport data anggota: ${members.length} anggota`, 
                { exportCount: members.length }
            );
            
            alert(` Berhasil mengexport ${members.length} data anggota!`);
        }

        function deleteMember(id) {
            if (!confirm('Yakin ingin menghapus anggota ini?')) {
                return;
            }

            if (!currentUser.isAdmin && !adminEmails.includes(currentUser.email.toLowerCase())) {
                alert(' Hanya admin yang bisa menghapus anggota!');
                return;
            }

            const member = members.find(m => m.id === id);
            if (!member) return;

            members = members.filter(m => m.id !== id);
            localStorage.setItem('tasksmate_members', JSON.stringify(members));
            
            tasks.forEach(task => {
                if (task.assignedTo && task.assignedTo.includes(member.name)) {
                    task.assignedTo = task.assignedTo.filter(name => name !== member.name);
                }
            });
            
            assignments = assignments.filter(a => a.memberId !== id);
            
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            localStorage.setItem('tasksmate_assignments', JSON.stringify(assignments));
            
            logActivity(ACTIVITY_TYPES.MEMBER_DELETED, 
                `Menghapus anggota tim: "${member.name}"`, 
                { memberId: id, memberName: member.name }
            );
            
            loadMembersTable();
            loadAssignMembersSelect();
            loadTasks();
            updateDashboard();
            updateRecipientSelect();
            alert('Anggota berhasil dihapus!');
        }

        function generateAssignments() {
            if (tasks.length === 0 || members.length === 0) {
                alert('Pastikan sudah ada tugas dan anggota tim!');
                return;
            }

            const assignType = document.getElementById('autoAssignType').value;
            
            if (assignType === 'manual' || assignType === '') {
                alert('Pilih metode pembagian tugas terlebih dahulu!');
                return;
            }
            
            assignments = [];
            
            const activeTasks = tasks.filter(t => !t.isArchived);
            
            if (assignType === 'equal') {
                activeTasks.forEach(task => {
                    task.assignedTo = members.map(m => m.name);
                    
                    members.forEach(member => {
                        const assignment = {
                            id: Date.now() + Math.random(),
                            taskId: task.id,
                            taskName: task.name,
                            memberId: member.id,
                            memberName: member.name,
                            assignedBy: currentUser.name,
                            assignedAt: new Date().toISOString(),
                            status: 'pending',
                            reason: `Ditugaskan secara merata ke semua anggota`
                        };
                        
                        assignments.push(assignment);
                    });
                });
                
                alert(` ${activeTasks.length} tugas telah dibagi ke semua ${members.length} anggota!`);
                
            } else if (assignType === 'skills') {
                activeTasks.forEach(task => {
                    const matchedMembers = [];
                    members.forEach(member => {
                        let shouldAssign = false;
                        let reason = '';
                        
                        if (task.category === 'design' && member.hardSkills) {
                            const designSkills = member.hardSkills.filter(s => 
                                s.toLowerCase().includes('design') || 
                                s.toLowerCase().includes('ui') || 
                                s.toLowerCase().includes('ux') ||
                                s.toLowerCase().includes('photoshop') ||
                                s.toLowerCase().includes('figma')
                            );
                            if (designSkills.length > 0) {
                                shouldAssign = true;
                                reason = `Memiliki skills desain: ${designSkills.join(', ')}`;
                            }
                        } else if (task.category === 'development' && member.hardSkills) {
                            const devSkills = member.hardSkills.filter(s => 
                                s.toLowerCase().includes('programming') || 
                                s.toLowerCase().includes('coding') || 
                                s.toLowerCase().includes('javascript') ||
                                s.toLowerCase().includes('python') ||
                                s.toLowerCase().includes('java') ||
                                s.toLowerCase().includes('web')
                            );
                            if (devSkills.length > 0) {
                                shouldAssign = true;
                                reason = `Memiliki skills pengembangan: ${devSkills.join(', ')}`;
                            }
                        } else if (task.category === 'marketing' && member.hardSkills) {
                            const marketingSkills = member.hardSkills.filter(s => 
                                s.toLowerCase().includes('marketing') || 
                                s.toLowerCase().includes('social media') || 
                                s.toLowerCase().includes('seo') ||
                                s.toLowerCase().includes('content')
                            );
                            if (marketingSkills.length > 0) {
                                shouldAssign = true;
                                reason = `Memiliki skills pemasaran: ${marketingSkills.join(', ')}`;
                            }
                        } else if (task.category === 'research' && member.softSkills) {
                            const researchSkills = member.softSkills.filter(s => 
                                s.toLowerCase().includes('analytical') || 
                                s.toLowerCase().includes('research') || 
                                s.toLowerCase().includes('problem solving')
                            );
                            if (researchSkills.length > 0) {
                                shouldAssign = true;
                                reason = `Memiliki skills riset: ${researchSkills.join(', ')}`;
                            }
                        }
                        
                        if (!shouldAssign && member.strength) {
                            const strength = member.strength.toLowerCase();
                            const taskName = task.name.toLowerCase();
                            
                            if (strength.includes(taskName.split(' ')[0]) || 
                                taskName.includes(strength.split(' ')[0])) {
                                shouldAssign = true;
                                reason = `Memiliki kelebihan: ${member.strength}`;
                            }
                        }
                        
                        if (shouldAssign) {
                            matchedMembers.push(member.name);
                            
                            const assignment = {
                                id: Date.now() + Math.random(),
                                taskId: task.id,
                                taskName: task.name,
                                memberId: member.id,
                                memberName: member.name,
                                assignedBy: currentUser.name,
                                assignedAt: new Date().toISOString(),
                                status: 'pending',
                                reason: reason
                            };
                            
                            assignments.push(assignment);
                        }
                    });
                    
                    task.assignedTo = matchedMembers;
                });
                
                alert(` Tugas telah dibagi berdasarkan skills anggota!`);
                
            } else if (assignType === 'random') {
                activeTasks.forEach(task => {
                    const assignedMembers = [];
                    const memberCount = Math.max(1, Math.floor(Math.random() * members.length) + 1);
                    
                    const shuffledMembers = [...members].sort(() => Math.random() - 0.5);
                    const selectedMembers = shuffledMembers.slice(0, memberCount);
                    
                    selectedMembers.forEach(member => {
                        assignedMembers.push(member.name);
                        
                        const assignment = {
                            id: Date.now() + Math.random(),
                            taskId: task.id,
                            taskName: task.name,
                            memberId: member.id,
                            memberName: member.name,
                            assignedBy: currentUser.name,
                            assignedAt: new Date().toISOString(),
                            status: 'pending',
                            reason: `Ditugaskan secara random`
                        };
                        
                        assignments.push(assignment);
                    });
                    
                    task.assignedTo = assignedMembers;
                });
                
                alert(` Tugas telah dibagi secara random ke anggota!`);
            }
            
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            localStorage.setItem('tasksmate_assignments', JSON.stringify(assignments));
            
            logActivity(ACTIVITY_TYPES.ASSIGNMENT_GENERATED, 
                `Membuat pembagian tugas (metode: ${assignType}) untuk ${activeTasks.length} tugas`, 
                { taskCount: activeTasks.length, memberCount: members.length, assignType }
            );
            
            loadTasks();
            loadAssignments();
        }

        function loadAssignments() {
            const container = document.getElementById('assignmentsList');
            if (assignments.length === 0) {
                container.innerHTML = '<p class="text-muted">Belum ada pembagian tugas. Pilih metode dan klik "Generate Pembagian Tugas" untuk membuat.</p>';
                return;
            }

            const assignmentsByTask = {};
            assignments.forEach(assignment => {
                if (!assignmentsByTask[assignment.taskId]) {
                    assignmentsByTask[assignment.taskId] = {
                        taskName: assignment.taskName,
                        assignments: []
                    };
                }
                assignmentsByTask[assignment.taskId].assignments.push(assignment);
            });

            container.innerHTML = '';
            Object.values(assignmentsByTask).forEach(taskAssignment => {
                container.innerHTML += `
                    <div class="assignment-card">
                        <h5><i class="fas fa-tasks me-2"></i>${taskAssignment.taskName}</h5>
                        <p class="mb-2"><strong>Ditugaskan ke:</strong></p>
                        ${taskAssignment.assignments.map(assignment => `
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-user-circle me-2 text-success"></i>
                                <div class="flex-grow-1">
                                    <strong>${assignment.memberName}</strong>
                                    ${assignment.reason ? `<br><small class="text-muted">${assignment.reason}</small>` : ''}
                                </div>
                                <span class="badge bg-${assignment.status === 'completed' ? 'success' : 'warning'}">
                                    ${assignment.status === 'completed' ? 'Selesai' : 'Pending'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
        }

        function updateRecipientSelect() {
            const messageType = document.getElementById('messageType');
            const recipientSelect = document.getElementById('messageRecipient');
            
            if (messageType.value === 'private') {
                recipientSelect.style.display = 'block';
                recipientSelect.innerHTML = '<option value="">Pilih Penerima</option>';
                members.forEach(member => {
                    recipientSelect.innerHTML += `<option value="${member.name}">${member.name}</option>`;
                });
            } else {
                recipientSelect.style.display = 'none';
            }
        }

        function sendMessage(e) {
            e.preventDefault();
            const messageText = document.getElementById('messageInput').value;
            const messageType = document.getElementById('messageType').value;
            const recipient = document.getElementById('messageRecipient').value;

            if (messageType === 'private' && !recipient) {
                alert('Pilih penerima pesan!');
                return;
            }

            messages.push({
                id: Date.now(),
                sender: currentUser.name,
                text: messageText,
                type: messageType,
                recipient: recipient || 'Semua',
                timestamp: new Date().toLocaleString('id-ID')
            });

            localStorage.setItem('tasksmate_messages', JSON.stringify(messages));
            
            logActivity(ACTIVITY_TYPES.CHAT_MESSAGE, 
                `Mengirim pesan ${messageType}`, 
                { messageType, recipient: recipient || 'all', messageLength: messageText.length }
            );
            
            document.getElementById('messageInput').value = '';
            loadMessages();
            updateDashboard();
        }

        function loadMessages() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            
            const relevantMessages = messages.filter(msg => 
                msg.type === 'public' || 
                msg.sender === currentUser.name || 
                msg.recipient === currentUser.name
            );
            
            if (relevantMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Belum ada pesan. Mulai percakapan!</p>
                    </div>
                `;
                return;
            }
            
            relevantMessages.forEach(msg => {
                container.innerHTML += `
                    <div class="message ${msg.type}">
                        <div class="message-header">
                            <i class="fas fa-user-circle me-2"></i>${msg.sender} 
                            ${msg.type === 'private' ? `<i class="fas fa-arrow-right mx-2"></i> ${msg.recipient}` : ''}
                            <span class="message-time float-end">${msg.timestamp}</span>
                        </div>
                        <div>${msg.text}</div>
                    </div>
                `;
            });
            container.scrollTop = container.scrollHeight;
        }

        let displayedActivities = 20;
        
        function loadActivities() {
            const container = document.getElementById('activitiesList');
            const emptyState = document.getElementById('emptyActivities');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            
            if (activities.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                loadMoreContainer.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            const filteredActivities = filterActivityList();
            const activitiesToShow = filteredActivities.slice(0, displayedActivities);
            
            if (filteredActivities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h5>Tidak ada aktivitas yang sesuai filter</h5>
                        <p>Coba ubah filter pencarian</p>
                    </div>
                `;
                loadMoreContainer.style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            activitiesToShow.forEach(activity => {
                const activityDate = new Date(activity.timestamp);
                const icon = ACTIVITY_ICONS[activity.type] || 'fas fa-info-circle';
                const colorClass = ACTIVITY_COLORS[activity.type] || 'info';
                
                let details = '';
                if (activity.data) {
                    if (activity.type === ACTIVITY_TYPES.TASK_STATUS_CHANGED) {
                        details = `Tugas: ${activity.data.taskName}<br>
                                  Status: ${activity.data.oldStatus}  ${activity.data.newStatus}`;
                    } else if (activity.data.taskName) {
                        details = `Tugas: ${activity.data.taskName}`;
                    } else if (activity.data.memberName) {
                        details = `Anggota: ${activity.data.memberName}`;
                    } else if (activity.data.subtaskName) {
                        details = `Subtask: ${activity.data.subtaskName}`;
                    }
                }
                
                container.innerHTML += `
                    <div class="activity-item ${colorClass}">
                        <div class="d-flex align-items-center">
                            <div class="activity-icon">
                                <i class="${icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <span class="activity-user">${activity.user}</span>
                                <span class="activity-time">
                                    <i class="far fa-clock me-1"></i>
                                    ${activityDate.toLocaleString('id-ID')}
                                </span>
                            </div>
                        </div>
                        <div class="activity-content">
                            ${activity.details}
                        </div>
                        ${details ? `<div class="activity-details">${details}</div>` : ''}
                        <div class="activity-actions">
                            <small class="text-muted">
                                <i class="fas fa-laptop me-1"></i>${activity.browser}...
                            </small>
                            <small class="text-muted ms-auto">
                                IP: ${activity.ipAddress}
                            </small>
                        </div>
                    </div>
                `;
            });
            
            if (filteredActivities.length > displayedActivities) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }
        
        function filterActivityList() {
            const typeFilter = document.getElementById('activityTypeFilter').value;
            const userFilter = document.getElementById('activityUserFilter').value;
            const timeFilter = document.getElementById('activityTimeFilter').value;
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            
            let filtered = activities;
            
            if (typeFilter !== 'all') {
                filtered = filtered.filter(activity => {
                    if (typeFilter === 'task') {
                        return activity.type.includes('task');
                    } else if (typeFilter === 'member') {
                        return activity.type.includes('member');
                    } else if (typeFilter === 'assignment') {
                        return activity.type.includes('assignment');
                    } else if (typeFilter === 'chat') {
                        return activity.type === ACTIVITY_TYPES.CHAT_MESSAGE;
                    } else if (typeFilter === 'system') {
                        return activity.type === ACTIVITY_TYPES.SYSTEM;
                    } else if (typeFilter === 'archive') {
                        return activity.type === ACTIVITY_TYPES.TASK_ARCHIVED;
                    }
                    return activity.type === typeFilter;
                });
            }
            
            if (userFilter === 'me' && currentUser) {
                filtered = filtered.filter(activity => activity.userId === currentUser.id);
            }
            
            const now = new Date();
            if (timeFilter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filtered = filtered.filter(activity => 
                    new Date(activity.timestamp) >= today
                );
            } else if (timeFilter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filtered = filtered.filter(activity => 
                    new Date(activity.timestamp) >= weekAgo
                );
            } else if (timeFilter === 'month') {
                const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                filtered = filtered.filter(activity => 
                    new Date(activity.timestamp) >= monthAgo
                );
            }
            
            if (searchTerm) {
                filtered = filtered.filter(activity => 
                    activity.details.toLowerCase().includes(searchTerm) ||
                    activity.user.toLowerCase().includes(searchTerm) ||
                    (activity.data && JSON.stringify(activity.data).toLowerCase().includes(searchTerm))
                );
            }
            
            return filtered;
        }
        
        function filterActivities() {
            displayedActivities = 20;
            loadActivities();
            updateActivityStats();
        }
        
        function searchActivities() {
            displayedActivities = 20;
            loadActivities();
        }
        
        function loadMoreActivities() {
            displayedActivities += 20;
            loadActivities();
        }
        
        function updateActivityStats() {
            const filteredActivities = filterActivityList();
            const today = new Date().toDateString();
            
            const todayActivities = activities.filter(act => 
                new Date(act.timestamp).toDateString() === today
            ).length;
            document.getElementById('activityToday').textContent = todayActivities;
            
            const taskActivities = activities.filter(act => 
                act.type.includes('task')
            ).length;
            document.getElementById('activityTasks').textContent = taskActivities;
            
            const memberActivities = activities.filter(act => 
                act.type.includes('member')
            ).length;
            document.getElementById('activityMembers').textContent = memberActivities;
            
            const myActivities = activities.filter(act => 
                act.userId === currentUser.id
            ).length;
            document.getElementById('activityMy').textContent = myActivities;
        }
        
        function exportActivities() {
            const filteredActivities = filterActivityList();
            
            if (filteredActivities.length === 0) {
                alert('Tidak ada data untuk diexport!');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Timestamp,User,Activity Type,Details,Additional Data\n";
            
            filteredActivities.forEach(activity => {
                const row = [
                    new Date(activity.timestamp).toLocaleString('id-ID'),
                    activity.user,
                    activity.type,
                    activity.details,
                    activity.data ? JSON.stringify(activity.data) : ''
                ].map(field => `"${field}"`).join(",");
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `activity_log_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            logActivity(ACTIVITY_TYPES.SYSTEM, 
                `Mengexport log aktivitas: ${filteredActivities.length} entri`, 
                { entryCount: filteredActivities.length }
            );
            
            alert(` Berhasil mengexport ${filteredActivities.length} aktivitas!`);
        }
        
        function clearActivities() {
            if (activities.length === 0) {
                alert('Riwayat aktivitas sudah kosong!');
                return;
            }
            
            if (confirm('Yakin ingin menghapus semua riwayat aktivitas? Tindakan ini tidak dapat dibatalkan!')) {
                logActivity(ACTIVITY_TYPES.SYSTEM, 
                    'Menghapus semua riwayat aktivitas', 
                    { clearedCount: activities.length }
                );
                
                activities = [];
                localStorage.setItem('tasksmate_activities', JSON.stringify(activities));
                
                loadActivities();
                updateActivityStats();
                alert('Riwayat aktivitas berhasil dihapus!');
            }
        }

        function showAdminPanel() {
            if (!currentUser.isAdmin && !adminEmails.includes(currentUser.email.toLowerCase())) {
                alert(' Akses ditolak! Hanya admin yang bisa mengakses panel ini.');
                return;
            }
            
            loadAdminPanel();
            const modal = new bootstrap.Modal(document.getElementById('adminModal'));
            modal.show();
        }

        function loadAdminPanel() {
            const tbody = document.getElementById('adminUsersTable');
            const emptyState = document.getElementById('adminEmptyState');
            
            if (users.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                updateAdminStats();
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            users.forEach((user, index) => {
                const joinDate = new Date(user.createdAt).toLocaleDateString('id-ID');
                const lastLogin = user.lastLogin ? 
                    new Date(user.lastLogin).toLocaleString('id-ID') : 'Belum pernah';
                
                const isCurrentUser = currentUser && user.id === currentUser.id;
                const isAdminUser = user.isAdmin || adminEmails.includes(user.email.toLowerCase());
                
                html += `
                    <tr ${isCurrentUser ? 'class="table-info"' : ''}>
                        <td>${index + 1}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="user-status ${user.isActive ? 'online' : 'offline'}"></span>
                                <span>${user.name}</span>
                                ${isCurrentUser ? '<span class="badge bg-info ms-2">Anda</span>' : ''}
                                ${isAdminUser ? '<span class="badge bg-danger ms-2">Admin</span>' : ''}
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td>
                            ${isAdminUser ? 
                                '<span class="badge bg-danger">Admin</span>' : 
                                '<span class="badge bg-secondary">Member</span>'
                            }
                        </td>
                        <td>
                            ${user.isActive ? 
                                '<span class="badge bg-success">Aktif</span>' : 
                                '<span class="badge bg-secondary">Nonaktif</span>'
                            }
                            <br>
                            <small class="last-activity">Login: ${user.loginCount || 0}x</small>
                        </td>
                        <td>${joinDate}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                ${!isAdminUser || isCurrentUser ? `
                                    <button class="btn btn-outline-info" onclick="viewUserDetails(${user.id})" 
                                            title="Detail" ${isCurrentUser ? 'disabled' : ''}>
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="editUserRole(${user.id})" 
                                            title="Edit Role" ${isCurrentUser ? 'disabled' : ''}>
                                        <i class="fas fa-user-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="confirmDeleteUser(${user.id})" 
                                            title="Hapus" ${isCurrentUser ? 'disabled' : ''}>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-outline-secondary" disabled title="Admin tidak bisa dihapus">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateAdminStats();
        }

        function updateAdminStats() {
            document.getElementById('adminTotalUsers').textContent = users.length;
            
            const adminUsers = users.filter(u => u.isAdmin || adminEmails.includes(u.email.toLowerCase())).length;
            document.getElementById('adminTotalAdmins').textContent = adminUsers;
            
            const activeUsers = users.filter(u => u.isActive).length;
            document.getElementById('adminActiveUsers').textContent = activeUsers;
            
            const inactiveUsers = users.length - activeUsers;
            document.getElementById('adminInactiveUsers').textContent = inactiveUsers;
        }

        function filterAdminUsers() {
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
            const roleFilter = document.getElementById('adminFilterRole').value;
            const statusFilter = document.getElementById('adminFilterStatus').value;
            
            const tbody = document.getElementById('adminUsersTable');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                if (cells.length < 6) continue;
                
                const name = cells[1].textContent.toLowerCase();
                const email = cells[2].textContent.toLowerCase();
                const role = cells[3].textContent.toLowerCase();
                const status = cells[4].textContent.toLowerCase();
                
                let showRow = true;
                
                if (searchTerm && !name.includes(searchTerm) && !email.includes(searchTerm)) {
                    showRow = false;
                }
                
                if (roleFilter !== 'all') {
                    if (roleFilter === 'admin' && !role.includes('admin')) {
                        showRow = false;
                    } else if (roleFilter === 'member' && role.includes('admin')) {
                        showRow = false;
                    }
                }
                
                if (statusFilter !== 'all') {
                    if (statusFilter === 'active' && !status.includes('aktif')) {
                        showRow = false;
                    } else if (statusFilter === 'inactive' && status.includes('aktif')) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        let userToDelete = null;

        function confirmDeleteUser(userId) {
            userToDelete = userId;
            const user = users.find(u => u.id === userId);
            
            if (!user) return;
            
            document.getElementById('deleteMemberName').textContent = user.name;
            document.getElementById('deleteMemberEmail').textContent = user.email;
            
            document.getElementById('confirmDeleteCheck').checked = false;
            document.getElementById('confirmDeleteMemberBtn').disabled = true;
            
            document.getElementById('confirmDeleteCheck').onchange = function() {
                document.getElementById('confirmDeleteMemberBtn').disabled = !this.checked;
            };
            
            const modal = new bootstrap.Modal(document.getElementById('deleteMemberModal'));
            modal.show();
            
            document.getElementById('confirmDeleteMemberBtn').onclick = deleteUserConfirmed;
        }

        function deleteUserConfirmed() {
            if (!userToDelete) return;
            
            const user = users.find(u => u.id === userToDelete);
            
            if (user.isAdmin || adminEmails.includes(user.email.toLowerCase())) {
                alert(' Tidak dapat menghapus akun admin!');
                userToDelete = null;
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteMemberModal'));
                modal.hide();
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === userToDelete);
            if (userIndex === -1) {
                alert('User tidak ditemukan!');
                return;
            }
            
            const deletedUser = users[userIndex];
            users.splice(userIndex, 1);
            localStorage.setItem('tasksmate_users', JSON.stringify(users));
            
            const memberIndex = members.findIndex(m => m.email === deletedUser.email || m.name === deletedUser.name);
            if (memberIndex !== -1) {
                members.splice(memberIndex, 1);
                localStorage.setItem('tasksmate_members', JSON.stringify(members));
            }
            
            const userTasks = tasks.filter(t => t.createdBy === deletedUser.name);
            userTasks.forEach(task => {
                const taskIndex = tasks.findIndex(t => t.id === task.id);
                if (taskIndex !== -1) {
                    tasks.splice(taskIndex, 1);
                }
            });
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            
            const userMessages = messages.filter(m => m.sender === deletedUser.name);
            userMessages.forEach(msg => {
                const msgIndex = messages.findIndex(m => m.id === msg.id);
                if (msgIndex !== -1) {
                    messages.splice(msgIndex, 1);
                }
            });
            localStorage.setItem('tasksmate_messages', JSON.stringify(messages));
            
            assignments = assignments.filter(a => a.memberName !== deletedUser.name);
            localStorage.setItem('tasksmate_assignments', JSON.stringify(assignments));
            
            logActivity(ACTIVITY_TYPES.MEMBER_DELETED, 
                `Menghapus user: "${deletedUser.name}" (${deletedUser.email})`, 
                { 
                    userId: deletedUser.id, 
                    userName: deletedUser.name,
                    tasksDeleted: userTasks.length,
                    messagesDeleted: userMessages.length
                }
            );
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteMemberModal'));
            modal.hide();
            
            loadAdminPanel();
            updateDashboard();
            loadTasks();
            loadMembersTable();
            loadMessages();
            
            alert(` User "${deletedUser.name}" berhasil dihapus!`);
            
            userToDelete = null;
        }

        function viewUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const joinDate = new Date(user.createdAt).toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const lastLogin = user.lastLogin ? 
                new Date(user.lastLogin).toLocaleString('id-ID') : 'Belum pernah login';
            
            let details = `
                <strong>Nama:</strong> ${user.name}<br>
                <strong>Email:</strong> ${user.email}<br>
                <strong>Role:</strong> ${user.isAdmin ? 'Admin' : 'Member'}<br>
                <strong>Status:</strong> ${user.isActive ? 'Aktif' : 'Nonaktif'}<br>
                <strong>Bergabung:</strong> ${joinDate}<br>
                <strong>Login Terakhir:</strong> ${lastLogin}<br>
                <strong>Total Login:</strong> ${user.loginCount || 0} kali<br>
            `;
            
            if (user.permissions) {
                details += `<strong>Permissions:</strong> ${user.permissions.join(', ')}<br>`;
            }
            
            const member = members.find(m => m.email === user.email || m.name === user.name);
            if (member) {
                details += `<hr><strong>Data di Tim:</strong><br>`;
                details += `<strong>Kelebihan:</strong> ${member.strength || '-'}<br>`;
                details += `<strong>Kekurangan:</strong> ${member.weakness ? member.weakness.join(', ') : '-'}<br>`;
                details += `<strong>Soft Skills:</strong> ${member.softSkills ? member.softSkills.join(', ') : '-'}<br>`;
                details += `<strong>Hard Skills:</strong> ${member.hardSkills ? member.hardSkills.join(', ') : '-'}<br>`;
                details += `<strong>Catatan:</strong> ${member.notes || '-'}<br>`;
            }
            
            alert(` Detail User\n\n${details}`);
        }

        function editUserRole(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (user.isAdmin || adminEmails.includes(user.email)) {
                alert(' Role admin tidak bisa diubah!');
                return;
            }
            
            const newRole = prompt(`Ubah role untuk ${user.name}\n\nPilih role:\n1. admin\n2. member\n\nMasukkan pilihan (1 atau 2):`);
            
            if (newRole === '1' || newRole === 'admin') {
                user.isAdmin = true;
                user.role = 'admin';
                user.permissions = ['admin', 'delete', 'edit', 'view'];
                alert(` ${user.name} sekarang menjadi Admin!`);
                
                logActivity(ACTIVITY_TYPES.SYSTEM, 
                    `Mengubah role user "${user.name}" menjadi Admin`, 
                    { userId: user.id, userName: user.name, oldRole: 'member', newRole: 'admin' }
                );
            } else if (newRole === '2' || newRole === 'member') {
                user.isAdmin = false;
                user.role = 'member';
                user.permissions = ['view'];
                alert(` ${user.name} sekarang menjadi Member!`);
                
                logActivity(ACTIVITY_TYPES.SYSTEM, 
                    `Mengubah role user "${user.name}" menjadi Member`, 
                    { userId: user.id, userName: user.name, oldRole: 'admin', newRole: 'member' }
                );
            } else if (newRole) {
                alert('Pilihan tidak valid!');
                return;
            } else {
                return;
            }
            
            localStorage.setItem('tasksmate_users', JSON.stringify(users));
            loadAdminPanel();
        }

        function exportAdminData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "No,Nama,Email,Role,Status,Bergabung,Login Terakhir,Total Login\n";
            
            users.forEach((user, index) => {
                const row = [
                    index + 1,
                    user.name,
                    user.email,
                    user.isAdmin ? 'Admin' : 'Member',
                    user.isActive ? 'Aktif' : 'Nonaktif',
                    new Date(user.createdAt).toLocaleDateString('id-ID'),
                    user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('id-ID') : '-',
                    user.loginCount || 0
                ].map(field => `"${field}"`).join(",");
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `users_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            logActivity(ACTIVITY_TYPES.SYSTEM, 
                `Mengexport data users: ${users.length} user`, 
                { exportCount: users.length }
            );
            
            alert(` Berhasil mengexport ${users.length} data user!`);
        }

        function clearAllMembers() {
            if (users.length === 0) {
                alert('Tidak ada data user untuk direset!');
                return;
            }
            
            if (!confirm(' PERINGATAN! \n\nAnda akan menghapus SEMUA data user kecuali:\n1. Akun Anda sendiri\n2. Akun admin lainnya\n\nYakin ingin melanjutkan?')) {
                return;
            }
            
            const confirmation = prompt('Ketik "RESET" untuk mengonfirmasi:');
            if (confirmation !== 'RESET') {
                alert('Konfirmasi gagal!');
                return;
            }
            
            const usersToKeep = users.filter(user => 
                user.id === currentUser.id || 
                adminEmails.includes(user.email.toLowerCase())
            );
            
            const deletedCount = users.length - usersToKeep.length;
            
            if (deletedCount === 0) {
                alert('Tidak ada user yang akan dihapus!');
                return;
            }
            
            users = usersToKeep;
            localStorage.setItem('tasksmate_users', JSON.stringify(users));
            
            const adminNames = usersToKeep.map(u => u.name);
            members = members.filter(member => adminNames.includes(member.name));
            localStorage.setItem('tasksmate_members', JSON.stringify(members));
            
            tasks = tasks.filter(task => adminNames.includes(task.createdBy));
            localStorage.setItem('tasksmate_tasks', JSON.stringify(tasks));
            
            messages = messages.filter(msg => adminNames.includes(msg.sender));
            localStorage.setItem('tasksmate_messages', JSON.stringify(messages));
            
            assignments = assignments.filter(assign => adminNames.includes(assign.memberName));
            localStorage.setItem('tasksmate_assignments', JSON.stringify(assignments));
            
            archivedTasks = archivedTasks.filter(task => adminNames.includes(task.createdBy));
            localStorage.setItem('tasksmate_archived_tasks', JSON.stringify(archivedTasks));
            
            logActivity(ACTIVITY_TYPES.SYSTEM, 
                `Reset semua data user: ${deletedCount} user dihapus`, 
                { deletedUserCount: deletedCount }
            );
            
            loadAdminPanel();
            updateDashboard();
            loadTasks();
            loadMembersTable();
            loadMessages();
            
            alert(` Reset berhasil! ${deletedCount} user telah dihapus.`);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        setTimeout(() => {
            if (currentUser) {
                logActivity(ACTIVITY_TYPES.SYSTEM, 'Aplikasi dimuat dengan sukses');
            }
        }, 1000);

        setInterval(checkOverdueTasks, 300000);
    </script>
</body>
</html>